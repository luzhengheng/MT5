# Prometheus 基础设施告警规则
# 涵盖服务器、系统资源、关键服务的监控

groups:
  - name: Infrastructure Alerts
    interval: 30s
    rules:
      # ========================================
      # 1. 服务器离线告警
      # ========================================
      - alert: ServerDown
        expr: up{job="node"} == 0
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.instance }}"
        annotations:
          summary: "服务器离线: {{ $labels.instance }}"
          description: "{{ $labels.instance }} 已离线超过2分钟,请立即检查"
          dashboard_url: "http://localhost:3000/d/node-exporter"

      # ========================================
      # 2. CPU 使用率告警
      # ========================================
      - alert: HighCPUUsage
        expr: |
          (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "CPU使用率过高: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} CPU使用率为 {{ $value | humanize }}%
            当前时间: {{ now | date "2006-01-02 15:04:05" }}
          runbook_url: "http://docs/runbooks/high-cpu-usage"

      - alert: CriticalCPUUsage
        expr: |
          (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 95
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.instance }}"
        annotations:
          summary: "CPU使用率极高: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} CPU使用率为 {{ $value | humanize }}%
            需要立即采取行动!

      # ========================================
      # 3. 内存使用率告警
      # ========================================
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes{} / node_memory_MemTotal_bytes{})) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "内存使用率过高: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} 内存使用率为 {{ $value | humanize }}%
            可用内存: {{ (node_memory_MemAvailable_bytes{instance=~"{{ $labels.instance }}"} / 1024 / 1024 / 1024) | humanize }}GB
          dashboard_url: "http://localhost:3000/d/node-exporter"

      - alert: CriticalMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes{} / node_memory_MemTotal_bytes{})) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.instance }}"
        annotations:
          summary: "内存使用率极高: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} 内存使用率为 {{ $value | humanize }}%
            立即处理!

      # ========================================
      # 4. 磁盘使用率告警
      # ========================================
      - alert: HighDiskUsage
        expr: |
          (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"} / node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"})) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
          device: "{{ $labels.device }}"
        annotations:
          summary: "磁盘使用率过高: {{ $labels.device }} ({{ $labels.instance }})"
          description: |
            {{ $labels.device }} 使用率为 {{ $value | humanize }}%
            挂载点: {{ $labels.mountpoint }}
            剩余空间: {{ (node_filesystem_avail_bytes{instance=~"{{ $labels.instance }}", device=~"{{ $labels.device }}"} / 1024 / 1024 / 1024) | humanize }}GB

      - alert: CriticalDiskUsage
        expr: |
          (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"} / node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"})) * 100 > 90
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.instance }}"
          device: "{{ $labels.device }}"
        annotations:
          summary: "磁盘即将满满: {{ $labels.device }} ({{ $labels.instance }})"
          description: |
            {{ $labels.device }} 使用率达 {{ $value | humanize }}%
            立即清理磁盘空间!

      # ========================================
      # 5. inode 使用率告警
      # ========================================
      - alert: HighInodeUsage
        expr: |
          (1 - (node_filesystem_files_free{fstype!~"tmpfs"} / node_filesystem_files{fstype!~"tmpfs"})) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
          device: "{{ $labels.device }}"
        annotations:
          summary: "inode使用率过高: {{ $labels.device }} ({{ $labels.instance }})"
          description: |
            {{ $labels.device }} inode使用率为 {{ $value | humanize }}%
            需要清理旧文件

      # ========================================
      # 6. 系统负载告警
      # ========================================
      - alert: HighSystemLoad
        expr: |
          node_load5{} > (count(node_cpu_seconds_total{mode="idle"}) by (instance) * 0.8)
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "系统负载过高: {{ $labels.instance }}"
          description: |
            5分钟平均负载: {{ $value | humanize }}
            CPU核心数: {{ count(node_cpu_seconds_total{mode="idle", instance=~"{{ $labels.instance }}"}) | humanize }}

      # ========================================
      # 7. 网络相关告警
      # ========================================
      - alert: HighNetworkErrorsIn
        expr: |
          rate(node_network_receive_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
          device: "{{ $labels.device }}"
        annotations:
          summary: "网络接收错误: {{ $labels.device }} ({{ $labels.instance }})"
          description: |
            {{ $labels.device }} 入站错误率: {{ $value | humanize }}/s
            可能存在网络问题

      - alert: HighNetworkErrorsOut
        expr: |
          rate(node_network_transmit_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
          device: "{{ $labels.device }}"
        annotations:
          summary: "网络发送错误: {{ $labels.device }} ({{ $labels.instance }})"
          description: |
            {{ $labels.device }} 出站错误率: {{ $value | humanize }}/s

      # ========================================
      # 8. Prometheus 监控服务告警
      # ========================================
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 2m
        labels:
          severity: critical
          service: "Prometheus"
        annotations:
          summary: "Prometheus 服务离线"
          description: "Prometheus 监控服务已离线,无法收集指标"

      - alert: PrometheusHighMemory
        expr: |
          process_resident_memory_bytes{job="prometheus"} > 1073741824
        for: 5m
        labels:
          severity: warning
          service: "Prometheus"
        annotations:
          summary: "Prometheus 内存使用过高"
          description: |
            Prometheus 内存使用: {{ $value | humanize }}
            可能需要调整配置或分片

      # ========================================
      # 9. Node Exporter 告警
      # ========================================
      - alert: NodeExporterDown
        expr: up{job="node"} == 0
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.instance }}"
        annotations:
          summary: "Node Exporter 离线: {{ $labels.instance }}"
          description: "{{ $labels.instance }} 的 Node Exporter 已离线"

      - alert: NodeExporterLatency
        expr: |
          histogram_quantile(0.95, rate(node_exporter_collector_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "Node Exporter 延迟高: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} 上 {{ $labels.collector }} 的采集延迟: {{ $value | humanize }}s

      # ========================================
      # 10. 文件描述符告警
      # ========================================
      - alert: HighFileDescriptorUsage
        expr: |
          (process_open_fds / process_max_fds) > 0.8
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.job }}"
        annotations:
          summary: "文件描述符使用率过高: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} 文件描述符使用率: {{ $value | humanizePercentage }}
            当前使用: {{ process_open_fds | humanize }}
            最大值: {{ process_max_fds | humanize }}

      # ========================================
      # 11. 时间同步告警
      # ========================================
      - alert: ClockSkew
        expr: |
          abs(node_timex_clock_offset_seconds) > 0.1
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "时间偏差过大: {{ $labels.instance }}"
          description: |
            {{ $labels.instance }} 时间偏差: {{ $value | humanize }}s
            需要同步NTP时间

      # ========================================
      # 12. 进程计数告警
      # ========================================
      - alert: HighProcessCount
        expr: |
          node_processes_running > (count(node_cpu_seconds_total{mode="idle"}) by (instance) * 10)
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "运行进程数过多: {{ $labels.instance }}"
          description: |
            运行进程数: {{ $value | humanize }}
            CPU核心数: {{ count(node_cpu_seconds_total{mode="idle", instance=~"{{ $labels.instance }}"}) | humanize }}

      # ========================================
      # 13. TCP 连接告警
      # ========================================
      - alert: HighTCPConnections
        expr: |
          node_sockstat_TCP_inuse > 10000
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "TCP连接数过多: {{ $labels.instance }}"
          description: |
            活跃TCP连接: {{ $value | humanize }}
            可能存在连接泄漏

      - alert: HighTCPTimeWait
        expr: |
          node_sockstat_TCP_tw > 5000
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
        annotations:
          summary: "TIME_WAIT连接过多: {{ $labels.instance }}"
          description: |
            TIME_WAIT连接数: {{ $value | humanize }}

      # ========================================
      # 14. 温度告警(如果可用)
      # ========================================
      - alert: HighSystemTemperature
        expr: |
          node_thermal_zone_temp > 80000
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.instance }}"
          zone: "{{ $labels.zone }}"
        annotations:
          summary: "系统温度过高: {{ $labels.instance }}"
          description: |
            {{ $labels.zone }} 温度: {{ $value | humanize }}
            需要检查散热系统
