name: Test Notion Bridge

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/ops/notion_bridge.py'
      - 'tests/test_notion_bridge*.py'
      - '.github/workflows/test-notion-bridge.yml'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/ops/notion_bridge.py'
      - 'tests/test_notion_bridge*.py'
      - 'requirements.txt'

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
      fail-fast: false

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov black flake8 mypy

      - name: Check code format with black
        run: |
          black --check scripts/ops/notion_bridge.py tests/test_notion_bridge*.py || true

      - name: Check code style with flake8
        run: |
          flake8 scripts/ops/notion_bridge.py tests/test_notion_bridge*.py --max-line-length=100 || true

      - name: Type check with mypy
        run: |
          mypy scripts/ops/notion_bridge.py --ignore-missing-imports || true

      - name: Run unit tests
        run: |
          pytest tests/test_notion_bridge_redos.py tests/test_notion_bridge_exceptions.py tests/test_notion_bridge_integration.py -v --cov=scripts.ops.notion_bridge --cov-report=xml --cov-report=html

      - name: Run performance benchmarks
        run: |
          pytest tests/test_notion_bridge_performance.py -v -m performance || true

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Generate coverage report
        if: matrix.python-version == '3.10'
        run: |
          coverage report
          coverage html

      - name: Archive coverage report
        if: matrix.python-version == '3.10'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov black flake8 mypy

      - name: Check syntax
        run: |
          python -m py_compile scripts/ops/notion_bridge.py
          python -m py_compile tests/test_notion_bridge_redos.py
          python -m py_compile tests/test_notion_bridge_exceptions.py
          python -m py_compile tests/test_notion_bridge_integration.py
          python -m py_compile tests/test_notion_bridge_performance.py

      - name: Verify imports
        run: |
          python -c "from scripts.ops.notion_bridge import validate_regex_safety; print('✅ ReDoS protection imported')"
          python -c "from scripts.ops.notion_bridge import NotionBridgeException; print('✅ Exception hierarchy imported')"
          python -c "from scripts.ops.notion_bridge import sanitize_task_id; print('✅ Task sanitization imported')"

      - name: Run all tests
        run: |
          pytest tests/test_notion_bridge*.py --tb=short --co -q || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, code-quality]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "✅ Notion Bridge tests completed"
          echo ""
          echo "Summary:"
          echo "  - Unit tests: ReDoS protection, Exception hierarchy, Integration"
          echo "  - Performance benchmarks: Regex, Exceptions, System-level"
          echo "  - Code quality: Format, Style, Type checking"
          echo ""
          echo "Next steps:"
          echo "  1. Review coverage report"
          echo "  2. Check performance baselines"
          echo "  3. Merge to main when ready"
