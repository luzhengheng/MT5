**工单标题：** 项目全局域名访问规范实施与切换（域名解析已完成）——v1
**优先级：** 高
**状态：** 进行中

---

## 目标

域名解析已全部配置完成，现要求项目全局工作彻底切换到域名访问方式。从即日起，所有操作、配置、文档、脚本中**非必要情况下禁止直接使用 IP 地址访问服务器**，必须统一使用已绑定域名，确保安全性、一致性和专业性。

---

## 域名与服务器对应关系（固定，不可更改）

| 服务器角色 | 域名 | 旧 IP 地址 |
|-----------|------|----------|
| 中枢服务器（主控、Claude Code CLI、Grafana 等） | www.crestive-code.com | 47.84.1.161 |
| 推理服务器（模型推理、实时预测服务等） | www.crestive.com | 47.84.111.158 |
| 训练服务器（模型训练、回测、大数据处理等） | www.guangzhoupeak.com | 8.138.100.136 |

---

## 执行步骤

### 1. 全局搜索并替换残留 IP（自动化脚本）

在项目根目录运行提供的自动化脚本，替换所有 IP 地址为对应域名：

```bash
bash scripts/domain_migration/replace_ips_with_domains.sh
```

**替换映射：**
- `47.84.1.161` → `www.crestive-code.com`
- `47.84.111.158` → `www.crestive.com`
- `8.138.100.136` → `www.guangzhoupeak.com`

**重点检查文件：**
- `CONTEXT.md`（包括所有分支）
- `.cursor/rules.md` 或 `.cursorrules.md`
- `README.md`、部署文档、配置文件
- `docs/knowledge/deployment/*.md`
- `scripts/**/*.sh`
- `scripts/**/*.yml` / `scripts/**/*.yaml`
- MQL5 源码、Python 脚本、API 调用地址
- SSH 配置文件（`~/.ssh/config`）、Cursor 设置备注

**重要提示：** 执行前请确保：
- 已备份项目或创建 git commit
- 验证脚本的替换规则（可在脚本中预检查）
- 不替换需要保留的开发示例或文档中的 IP（脚本已配置黑名单）

---

### 2. 配置本地 SSH 便捷域名登录

在本地电脑的 `~/.ssh/config` 文件中添加以下内容（每台电脑执行一次）：

```
Host crestive-code
    HostName www.crestive-code.com
    User root
    Port 22

Host crestive-inference
    HostName www.crestive.com
    User root
    Port 22

Host guangzhoupeak
    HostName www.guangzhoupeak.com
    User root
    Port 22
```

**保存后，登录命令示例：**

```bash
ssh crestive-code              # 连接中枢服务器
ssh crestive-inference         # 连接推理服务器
ssh guangzhoupeak              # 连接训练服务器
```

**自动化配置脚本（可选）：**

```bash
bash scripts/domain_migration/setup_ssh_config.sh
```

---

### 3. 更新项目文档添加全局访问规范

#### 3.1 在 CONTEXT.md 顶部添加规范说明

```markdown
### 🌐 服务器访问全局规范（强制执行）

- **规范原则**：所有服务器访问必须通过域名进行，禁止直接使用 IP 地址
  - 例外情况：仅在域名解析故障等极端情况下才使用旧 IP
  - 所有文档、脚本、通信记录中必须使用域名

- **三台服务器域名清单**：
  - **中枢服务器**：www.crestive-code.com（主控、Grafana、Prometheus）
  - **推理服务器**：www.crestive.com（模型推理、实时预测）
  - **训练服务器**：www.guangzhoupeak.com（模型训练、回测）

- **SSH 登录推荐方式**：
  - 使用 `~/.ssh/config` 配置的别名快速登录
  - `ssh crestive-code` / `ssh crestive-inference` / `ssh guangzhoupeak`
```

#### 3.2 在 .cursorrules.md 或 .cursor/rules.md 中添加 AI 行为约束

```markdown
## 服务器访问规范（AI 强制遵守）

- 当提到服务器访问时，始终使用域名：
  - www.crestive-code.com（中枢）
  - www.crestive.com（推理）
  - www.guangzhoupeak.com（训练）

- 不得输出裸 IP 地址（除非特别说明是文档参考）

- 如需提供登录命令：
  - 优先使用 SSH 别名：`ssh crestive-code` 等
  - 其次使用域名：`ssh root@www.crestive-code.com`
  - 不使用 IP：~~`ssh root@47.84.1.161`~~
```

---

### 4. 验证切换完成

运行验证脚本确保所有替换正确完成：

```bash
bash scripts/domain_migration/verify_domain_migration.sh
```

**验证清单：**
- [ ] 使用域名完整测试三台服务器的 SSH 访问
  ```bash
  ssh crestive-code "hostname && date"
  ssh crestive-inference "hostname && date"
  ssh guangzhoupeak "hostname && date"
  ```

- [ ] 检查项目关键文件（CONTEXT.md、部署文档等）是否已无裸 IP 残留
  ```bash
  grep -r "47\.84\|8\.138" . --include="*.md" --include="*.sh" --include="*.yml"
  ```

- [ ] 验证 Grafana 和 Prometheus 可通过域名访问
  ```bash
  curl -I http://www.crestive-code.com:3000
  curl -I http://www.crestive-code.com:9090
  ```

- [ ] 在 Cursor 新会话中输入 `@CONTEXT.md`，确认回复中服务器相关内容已使用域名

---

## 附录：自动化脚本说明

### 脚本目录结构

```
scripts/domain_migration/
├── replace_ips_with_domains.sh      # 主替换脚本
├── setup_ssh_config.sh              # SSH config 自动配置
├── verify_domain_migration.sh       # 验证脚本
├── whitelist.txt                    # 不替换的文件白名单
└── README.md                        # 脚本使用说明
```

### 脚本特性

- **安全机制**：自动备份原文件、生成替换报告
- **智能匹配**：避免替换示例 IP、注释、文档中的参考 IP
- **详细日志**：记录所有替换操作，便于审计和回滚

---

## 完成检查清单

- [ ] 运行自动化替换脚本，完成全局 IP → 域名转换
- [ ] 验证所有重点文件已正确替换
- [ ] 配置本地 SSH config，支持便捷别名登录
- [ ] 更新 CONTEXT.md 添加规范说明
- [ ] 更新 .cursorrules.md / .cursor/rules.md 添加 AI 约束
- [ ] 运行验证脚本，确保所有测试通过
- [ ] 创建 git commit 记录所有变更
- [ ] 在新 Cursor 会话验证 AI 已遵循新规范

---

## 完成后回复确认

项目全局域名访问规范实施工单（v1）已执行完成：
- ✅ 所有项目文件、配置、文档已彻底清除裸 IP，统一替换为对应域名
- ✅ 本地 SSH 已配置域名别名，便捷登录（crestive-code / crestive-inference / guangzhoupeak）
- ✅ 项目文档已添加"域名优先、禁止直接 IP 访问"强制规范
- ✅ AI 行为规则已更新，强制使用域名表述
- ✅ 已使用域名完整验证三台服务器访问正常
- ✅ 从即日起，项目全局工作正式进入域名化访问阶段，安全性与规范性大幅提升

---

## 结束语

域名解析已就位，本工单重点在于"执行切换"和"建立规范"。执行完成后，项目将彻底告别 IP 直连时代，所有操作更加专业、安全、可追溯。
