# 工单 #006 - 驱动管家系统

## 📋 基本信息

- **工单标题**: Redis Streams 生产级事件总线 + EODHD News API 接入
- **发布时间**: 2025年12月18日
- **工单周期**: 2025年12月18日 - 2026年1月上旬
- **优先级**: 高
- **状态**: 进行中
- **负责人**: Claude Sonnet 4.5
- **验证人**: Claude & Grok

## 🎯 目标

基于 Redis Streams 构建生产级低延迟、高可靠、可观测的事件驱动架构，接入 EODHD News API，实现新闻过滤原型，为交易驱动事件管理提供坚实基础。

## 🏗️ 系统架构

### 核心组件
1. **Redis Streams 事件总线**
   - 高性能消息队列
   - 消费者组负载均衡
   - 持久化和主从复制
   - 死信队列机制

2. **EODHD News API 数据源**
   - 定时拉取新闻数据
   - API 限流和熔断保护
   - 多 ticker 并行拉取

3. **事件处理管道**
   - News Raw → 过滤 → News Filtered
   - Sentiment 分析
   - Ticker 匹配
   - 关键词过滤

4. **监控告警系统**
   - Prometheus 指标收集
   - Grafana 可视化
   - 钉钉告警集成

### Stream 设计
```
mt5:events:news_raw         - 原始新闻事件
mt5:events:news_filtered    - 过滤后的新闻事件
mt5:events:deadletter       - 死信队列
```

### 消费者组设计
```
news-filter-group           - 新闻过滤消费者组
  ↳ consumer-1, consumer-2  - 多实例负载均衡
```

## 📋 任务清单

### 阶段 1: Redis 基础设施（第 1 周）

#### 1.1 Redis 服务端配置与部署
- [ ] 创建 `configs/redis/redis.conf` 配置文件
  - Stream 优化: `stream-node-max-bytes 8192`
  - Stream 优化: `stream-node-max-entries 200`
  - AOF 持久化: `appendonly yes`, `appendfsync everysec`
  - RDB 辅助: `save 60 1`
  - 内存策略: `maxmemory-policy allkeys-lru`

- [ ] 更新 `configs/docker/docker-compose.mt5-hub.yml`
  - 添加 Redis 主节点服务
  - 添加 Redis 从节点服务（可选）
  - 配置持久化卷
  - 配置网络

- [ ] 部署监控 Exporter
  - `oliver006/redis_exporter` - 通用 Redis 指标
  - `chrnola/redis-streams-exporter` - Streams 专用指标

#### 1.2 Redis Streams 基础验证
- [ ] 测试基本 XADD/XREAD 操作
- [ ] 测试消费者组创建和读取
- [ ] 验证持久化机制
- [ ] 验证主从复制（如果配置）

### 阶段 2: 事件总线实现（第 1-2 周）

#### 2.1 项目结构创建
```
src/
├── event_bus/
│   ├── __init__.py
│   ├── producer.py         - 事件生产者
│   ├── consumer.py         - 事件消费者
│   ├── config.py           - Redis 配置
│   └── models.py           - 事件数据模型
├── news_service/
│   ├── __init__.py
│   ├── eodhd_client.py     - EODHD API 客户端
│   ├── fetcher.py          - 新闻拉取服务
│   └── filter.py           - 新闻过滤逻辑
└── requirements.txt
```

#### 2.2 事件生产者实现
- [ ] 实现 `EventProducer` 类
  - XADD 发布事件
  - 使用 `maxlen ~ 30000` 近似裁剪
  - 错误处理和重试
  - 性能监控（发布延迟）

#### 2.3 事件消费者实现
- [ ] 实现 `EventConsumer` 基类
  - 消费者组自动创建
  - XREADGROUP 阻塞读取（BLOCK=5000ms）
  - 批量处理和批量 ACK
  - 优雅关闭处理

- [ ] 实现 PEL 自动重试机制
  - XAUTOCLAIM（min_idle_time_ms=300000）
  - 失败计数跟踪
  - 重试次数限制

- [ ] 实现死信队列机制
  - 失败次数 > 3 移至 deadletter
  - 死信事件监控告警

#### 2.4 PoC 测试
- [ ] 启动多个消费者实例验证负载均衡
- [ ] 模拟消费者崩溃验证自动恢复
- [ ] 验证消息零丢失
- [ ] 测试端到端延迟 < 1s

### 阶段 3: EODHD News API 接入（第 2 周）

#### 3.1 API 客户端实现
- [ ] 安装 `eodhd` 官方 Python 库
- [ ] 实现 `EODHDClient` 类
  - API Key 从环境变量读取
  - `financial_news()` 接口封装
  - 分页支持
  - 限流控制（rate limiting）
  - 熔断保护（circuit breaker）

#### 3.2 定时拉取服务
- [ ] 选择调度方案（APScheduler 或 Celery beat）
- [ ] 实现 `NewsFetcher` 服务
  - 从配置读取 watchlist tickers
  - 并行拉取多个 ticker 新闻
  - 每 5-15 分钟执行一次
  - 增量拉取（基于时间戳）

- [ ] 事件发布集成
  - 新闻数据序列化为 JSON
  - 发布到 `mt5:events:news_raw`
  - 添加元数据（fetch_time, source, ticker）

#### 3.3 错误处理
- [ ] API 调用失败重试
- [ ] API 配额耗尽告警
- [ ] 网络超时处理

### 阶段 4: 新闻过滤原型（第 2 周）

#### 4.1 过滤器实现
- [ ] 实现 `NewsFilterConsumer` 类
  - 继承 `EventConsumer`
  - 消费 `mt5:events:news_raw`
  - 发布到 `mt5:events:news_filtered`

- [ ] 过滤逻辑实现
  - Sentiment 分析（sentiment > 0.5）
  - Ticker 白名单匹配
  - 关键词过滤（可配置）
  - 时效性过滤（发布时间 < 24h）

#### 4.2 Sentiment 分析
- [ ] 选择 sentiment 库（TextBlob, VADER, FinBERT）
- [ ] 实现 sentiment 计算
- [ ] 添加 sentiment 缓存（相同新闻标题）

#### 4.3 端到端测试
- [ ] 发布测试新闻事件
- [ ] 验证过滤逻辑正确性
- [ ] 测量端到端延迟
- [ ] 验证过滤准确率

### 阶段 5: 监控集成（第 2-3 周）

#### 5.1 Prometheus 指标
- [ ] 添加自定义指标
  - `redis_stream_length` - Stream 长度
  - `redis_consumer_lag` - 消费者 lag
  - `redis_pending_messages` - PEL 大小
  - `news_fetch_success/failure` - API 调用成功/失败
  - `news_filter_processed` - 过滤处理计数
  - `event_processing_latency` - 处理延迟

- [ ] 配置 Redis Exporter 采集规则

#### 5.2 Grafana Dashboard
- [ ] 创建 Redis Streams 监控面板
  - Stream 长度趋势
  - 消费者 lag 趋势
  - PEL 趋势
  - 吞吐量（msg/s）

- [ ] 创建 News Service 监控面板
  - API 调用成功率
  - 新闻拉取速率
  - 过滤通过率
  - 端到端延迟分布

#### 5.3 告警规则
- [ ] Prometheus 告警规则
  ```yaml
  - alert: RedisPELTooHigh
    expr: redis_stream_pending > 100
    for: 5m

  - alert: RedisConsumerLagHigh
    expr: redis_consumer_lag > 1000
    for: 5m

  - alert: RedisStreamTooLong
    expr: redis_stream_length > 50000
    for: 10m

  - alert: NewsAPIFailureRate
    expr: rate(news_fetch_failure[5m]) > 0.1
    for: 5m
  ```

- [ ] 集成钉钉 Webhook 告警

## 🔧 技术栈

### 后端
- **Redis**: 7.x (Streams + 主从复制)
- **Python**: 3.9+
- **redis-py**: Redis Python 客户端
- **eodhd**: EODHD API Python 库
- **APScheduler**: 任务调度
- **TextBlob/VADER**: Sentiment 分析

### 监控
- **Prometheus**: 2.x
- **Grafana**: 12.x
- **redis_exporter**: Redis 通用指标
- **redis-streams-exporter**: Streams 专用指标

### 容器化
- **Podman/Docker**: 容器运行时
- **Docker Compose**: 服务编排

## 📊 性能目标

- **端到端延迟**: < 1s (p95)
- **消息吞吐**: > 1000 msg/s
- **消息零丢失**: 100% (通过 ACK 和死信机制)
- **可用性**: 99.9% (主从复制 + 自动故障转移)
- **API 调用成功率**: > 99%

## ✅ 完成标准

### 基础设施
- [x] Redis 服务端部署完成，配置优化就绪
- [ ] 持久化机制验证通过（AOF + RDB）
- [ ] 主从复制配置完成（可选）
- [ ] 监控 Exporter 运行正常

### 事件总线
- [ ] EventProducer 和 EventConsumer 实现完整
- [ ] XAUTOCLAIM 自动重试机制工作正常
- [ ] 死信队列机制验证通过
- [ ] PoC 故障恢复测试通过

### News Service
- [ ] EODHD API 定时拉取正常工作
- [ ] 限流和熔断保护生效
- [ ] 新闻过滤逻辑准确
- [ ] Sentiment 分析结果合理

### 监控告警
- [ ] Prometheus 指标采集完整
- [ ] Grafana Dashboard 可视化清晰
- [ ] 告警规则触发准确
- [ ] 钉钉通知送达及时

### 测试验证
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 压力测试达标（1000+ msg/s）
- [ ] 端到端延迟 < 1s

## 📝 文档要求

- [ ] Redis Streams 架构设计文档
- [ ] API 使用说明
- [ ] 部署运维手册
- [ ] 故障排查指南
- [ ] 监控指标说明

## 🔗 相关链接

- **Redis Streams 官方文档**: https://redis.io/docs/data-types/streams/
- **EODHD API 文档**: https://eodhd.com/financial-apis/
- **Python redis-py**: https://redis-py.readthedocs.io/

## 📅 里程碑

- **Week 1**: Redis 基础设施 + 事件总线核心实现
- **Week 2**: EODHD API 接入 + 新闻过滤原型
- **Week 3**: 监控集成 + 性能优化 + 文档完善

---

**创建时间**: 2025-12-18 23:00 UTC+8
**最后更新**: 2025-12-18 23:00 UTC+8
**工单版本**: v1.0

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
