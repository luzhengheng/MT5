好的，收到指令！🚀  
这是正式生成的 工单 #010。它是我们从“纸面富贵”（理论预测）跨越到“实战盈利”（策略落地）的关键一步。  
请直接复制以下内容发送给服务器上的 Claude Sonnet。  
📋 工单 #010：策略回测引擎与风险管理系统  
工单状态: 🟢 待执行 (Ready)  
优先级: 🔴 紧急 (Highest)  
前置依赖: #009 (ML 预测引擎完成)  
核心目标: 将 ML 模型的预测概率转化为可执行的交易指令，并通过严谨的事件驱动回测验证策略的盈利能力。  
1. 战略意图 (Strategic Intent)  
搭建连接“预测概率”与“实盘订单”的桥梁。我们拒绝“过拟合”的回测，我们需要构建一个模拟真实市场摩擦（滑点、点差、延迟）的仿真环境。  
核心理念：信号 \neq 指令。模型输出的是概率，而由于胜率和赔率的变化，仓位必须是动态调整的。  
2. 技术规格 (Technical Specs)  
 * 回测框架: Backtrader (必须使用此框架)。  
   * 理由: 其事件驱动 (Event-Driven) 架构能精确模拟 K 线内部的订单成交顺序，这对 Triple Barrier 策略至关重要。  
 * 数据源适配:  
   * 自定义 PandasData 类，直接读取 #009 生成的 features.parquet 和 predictions。  
   * 严禁在回测循环中重新计算特征，必须预先计算以保证速度。  
 * 注码策略 (Bet Sizing):  
   * 实现 Kelly Criterion (凯利公式) 变体。  
   * 公式逻辑: Position \propto \frac{P_{win} - 0.5}{\sigma_{volatility}}  
   * 模型置信度越高、市场波动率越低时，仓位越大。  
 * 评价指标:  
   * Deflated Sharpe Ratio (DSR): 必须计算概率调整后的夏普比率，剔除多重测试带来的“运气成分”。  
   * Calmar Ratio: 年化收益 / 最大回撤。  
3. Claude 执行任务清单 (Claude Tasks)  
任务 3.1: 搭建 Backtrader 策略适配器 (src/strategy/ml_strategy.py)  
 * 继承 bt.Strategy。  
 * 在 __init__ 中加载 ML 模型（或直接加载预测结果列）。  
 * 在 next() 方法中实现信号逻辑：当 y_pred_proba > threshold (如 0.6) 时触发买入信号。  
任务 3.2: 实现动态注码与风控 (src/strategy/risk_manager.py)  
 * 编写 KellySizer 类，继承自 bt.Sizer。  
 * 实现 DynamicRiskManager 类：  
   * 硬风控: 每笔交易固定止损 (ATR * k)。  
   * 软风控: 账户净值回撤 > 10% 强制熔断。  
 * 模拟真实的 MT5 环境：设置 commission (手续费，如万分之二) 和 slippage (滑点)。  
任务 3.3: 开发回测主程序 (bin/run_backtest.py)  
 * 支持命令行参数：--model-path, --start-date, --initial-cash。  
 * 实现 Walk-Forward Backtesting (WFB)：  
   * 利用 #009 src/models/validation.py 中的 WalkForwardValidator 逻辑。  
   * 确保回测严格在 Out-of-Sample (OOS) 数据上运行，严禁使用训练集数据进行回测。  
任务 3.4: 生成回测报告 (src/reporting/tearsheet.py)  
 * 使用 QuantStats 或自定义脚本生成 HTML 交互式报表。  
 * 绘制：累计收益曲线、回撤图、月度热力图。  
 * 关键输出: 计算并打印 DSR 值。  
4. 验收标准 (Acceptance Criteria)  
 * 真实性验证: 回测必须包含 双向交易成本 (点差 + 手续费)。无成本的回测结果视为无效。  
 * 基准对比: 策略表现必须优于“买入持有 (Buy & Hold)”策略。  
 * 稳定性: 在 Walk-Forward 验证中，训练集和测试集的夏普比率差异不得超过 30% (检测过拟合)。  
 * 工程交付: 提供 backtest_results/ 文件夹，内含 HTML 报表和 DSR 统计数据。  
💡 架构师给 Claude 的特别提示 (Architect's Note)  
> Claude，这一步是检验真理的时刻。  
>  * 关于效率：不要在 Backtrader 的 next() 循环里跑 LightGBM 的 predict()。请在策略初始化前，用 Pandas 批量生成好所有 Signal，作为一列 DataFeed 喂进去。  
>  * 关于 DSR：在计算 DSR 时，n_trials (试验次数) 请参考我们 #009 中 Optuna 运行的总次数（如果不确定，默认设为 100）。这是对我们之前大量调参行为的统计学惩罚。  
> 祝你的回测曲线是一条漂亮的 45 度向上直线！📈  
>   
请将上述内容转发给 Claude，让他开始构建我们的实战回测引擎吧！  
