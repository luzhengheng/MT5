# 🏗️ 工单 #010.9: 部署 "Notion Nexus" 知识库与自动化架构  
  
> **提交人**: 架构师 Gemini Pro  
> **执行人**: Claude Sonnet 4.5  
> **优先级**: P0 (阻塞 #011 实盘系统开发)  
> **状态**: 待执行  
> **前置条件**: 用户已在服务器部署 `nexus_bridge.py` 脚本  
  
---  
  
## 🎯 目标  
1. 在 Notion 中构建 "Nexus" 架构的 **4 个核心数据库**。  
2. 建立 Notion API 连接，打通 "Python脚本 ↔ Notion" 的自动化链路。  
3. 将工单 #010.5 的核心成果（Kelly 公式、DSR、并行化架构）迁移至新知识库。  
4. 正式初始化工单 #011。  
  
---  
  
## 🛠️ Phase 1: 数据库架构搭建 (Schema Setup)  
  
请指导用户在 Notion 页面 "MT5-CRS Nexus" 中创建以下 4 个数据库。  
**⚠️ 关键要求**: 数据库 1 的字段名称必须与 Python 脚本**完全一致**，否则自动化会失败。  
  
### 1. 🧠 AI Command Center (AI 协同控制台)  
*这是 Python 脚本直接监控的数据库。*  
- **Database Type**: Table (表格)  
- **字段定义**:  
  - `Topic` (Type: **Title**) -> *任务标题*  
  - `Status` (Type: **Status**)  
    - ⚪ `Draft` (默认)  
    - 🔵 `Ready to Send` (**触发器** - 必须设为蓝色，脚本监控此状态)  
    - 🟡 `Processing` (脚本处理中)  
    - 🟢 `Replied` (脚本已回复)  
  - `Context Files` (Type: **Multi-select**) -> *关键字段：用于填写本地文件路径，如 `src/strategy/risk_manager.py`*  
  - `Related Issue` (Type: **Relation**) -> *关联到 `📋 Issues`*  
  - `Extracted Knowledge` (Type: **Relation**) -> *关联到 `💡 Knowledge Graph`*  
  
*(注：具体的 Prompt 指令直接写在 Notion 页面正文中，脚本会自动读取，无需单独创建 Prompt 字段)*  
  
### 2. 📋 Issues (工单管理)  
*项目进度总控，替代本地 Markdown 文件。*  
- **Database Type**: Board (看板) 或 Table  
- **字段定义**:  
  - `Task Name` (Type: **Title**)  
  - `ID` (Type: **Text**) -> *例如 #011*  
  - `Status` (Type: **Status**) -> `Backlog`, `In Progress`, `Done`, `Blocked`  
  - `Priority` (Type: **Select**) -> `P0 (Critical)`, `P1 (High)`, `P2 (Normal)`  
  - `Timeline` (Type: **Date**) -> *用于甘特图*  
  - `Code Delta` (Type: **Number**) -> *代码行数变化*  
  
### 3. 💡 Knowledge Graph (知识图谱)  
*沉淀经过验证的原子知识。*  
- **Database Type**: Gallery (画廊) 或 Table  
- **字段定义**:  
  - `Concept` (Type: **Title**) -> *知识点名称*  
  - `Category` (Type: **Select**) -> `Math`, `Risk`, `Architecture`, `Infra`  
  - `Verification` (Type: **Status**) -> `✅ Verified`, `🧪 Theoretical`, `❌ Deprecated`  
  - `GitHub Permalink` (Type: **URL**) -> *指向代码特定行的永久链接*  
  
### 4. 📚 Documentation (文档归档)  
*存放旧的 Markdown 文件。*  
- **字段定义**:  
  - `Doc Name` (Type: **Title**)  
  - `Attachment` (Type: **Files & Media**) -> *用于上传文件*  
  
---  
  
## 🔌 Phase 2: 授权与连接 (Critical Integration)  
  
请指导用户执行以下操作（**这是最容易遗漏的步骤**）：  
  
1.  **连接机器人**:  
    - 进入 **`🧠 AI Command Center`** 数据库页面。  
    - 点击右上角 `...` -> `Connect to` (或 Connections)。  
    - 搜索并选择 **`MT5-CRS-Bot`**。  
    - 点击 Confirm 确认。  
  
2.  **获取 Database ID**:  
    - 指导用户在终端运行: `python nexus_bridge.py`  
    - 脚本会扫描并打印出 `🧠 AI Command Center` 的 ID。  
    - 指导用户复制该 ID，填入 `/opt/mt5-crs/.env` 文件的 `NOTION_DB_ID=` 字段。  
  
---  
  
## 🚚 Phase 3: 核心知识迁移 (Knowledge Migration)  
  
请协助用户将 **工单 #010.5** 经 Gemini 审查通过的关键技术成果录入到 **`💡 Knowledge Graph`**：  
  
**条目 1: 通用 Kelly 公式 (General Kelly Criterion)**  
- **Category**: Math  
- **Verification**: ✅ Verified  
- **内容描述**:  
  > Gemini 审查结论：修正了旧公式假设 b=1 的缺陷。  
  > **公式**: `f* = [p(b+1) - 1] / b`  
  > **实战应用**: 采用 Quarter Kelly (`0.25 * f*`) 以平滑波动。  
  > **验证**: 当 p=0.45, b=2.0 时，旧公式为负，新公式为 0.175 (允许开仓)。  
  
**条目 2: 缩减夏普比率 (Deflated Sharpe Ratio)**  
- **Category**: Risk  
- **Verification**: ✅ Verified  
- **内容描述**:  
  > 基于 Bailey & López de Prado (2014)。  
  > 随着回测次数 N 增加，SR 的显著性阈值需动态提高，以防止多重测试过拟合。  
  > **实现**: 使用 `trial_registry.json` 进行全局计数持久化。  
  
**条目 3: 并行回测架构 (Parallel Backtesting)**  
- **Category**: Architecture  
- **Verification**: ✅ Verified  
- **内容描述**:  
  > 使用 `ProcessPoolExecutor` + 顶层函数设计。  
  > 解决了 Pickle 序列化问题，支持大数据集 Walk-Forward 训练，符合 Python 多进程最佳实践。  
  
---  
  
## 🚀 Phase 4: 启动 #011 (Kick-off)  
  
1.  **创建工单**: 在 `📋 Issues` 中新建：  
    - **Name**: 实盘交易系统对接 (MT5 API)  
    - **ID**: #011  
    - **Status**: Backlog  
    - **Priority**: P1  
  
2.  **全链路测试**:  
    - 指导用户在 `🧠 AI Command Center` 新建一行：  
      - **Topic**: `系统自检：解释通用 Kelly 公式`  
      - **Context Files**: `src/strategy/risk_manager.py` (确保此文件路径存在)  
      - **Status**: 改为 `Ready to Send`  
    - **预期结果**: 观察终端输出 `🚀 处理任务...`，并在 Notion 页面看到 Gemini 的自动回复。  
  
---  
  
## ⚠️ 执行备注  
请务必按照清单顺序执行。在 Phase 2 完成且 ID 配置正确前，不要进行 Phase 4 的测试。  
