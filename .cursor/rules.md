# 项目全局规则与上下文（Cursor 自动加载，请勿删除此文件）

## 1. 项目概述
这是一个基于三台服务器协同的 MT5 全链路量化交易系统。
核心功能包括：
- 多服务器分布式架构（中枢/训练/推理）
- EODHD完整套餐数据拉取与多因子处理
- VectorBT回测框架 + GPU加速训练
- ONNX实时推理服务（毫秒级响应）
- 企业级监控告警（Grafana + Prometheus + 钉钉告警）

当前开发阶段：阶段1 - 中枢服务平台完善（数据拉取、监控告警、Runner部署进行中）

## 2. 技术栈与环境
- 平台：MetaTrader 5 (MQL5) + Python 3.11 + VectorBT + ONNX
- 主要库：MetaTrader5, pandas, numpy, torch, ta-lib, vectorbt, fastapi, onnxruntime
- 服务器架构：中枢服务器(新加坡)+训练服务器(GPU)+推理服务器(低延迟)
- 部署方式：Podman容器化 + GitHub Actions Runner + Grafana监控 + OSS备份

## 3. 代码规范（必须严格遵守）
- 文件命名：snake_case.mq5 或 snake_case.py
- 变量命名：camelCase
- 函数/类命名：PascalCase
- 常量：UPPER_SNAKE_CASE
- 缩进：4 个空格
- 注释要求：每个函数必须有中文功能说明，关键逻辑加注释
- 错误处理与日志：所有外部调用必须检查返回值并记录日志

## 4. 常用设计模式与最佳实践
- 订单执行前检查：重复下单、点差、仓位超限
- 信号生成：预测概率 > 0.7 且指标共振
- 风险控制：单笔风险 ≤ 1%，总浮亏 > 10% 暂停交易

## 5. 已知问题与解决方案
- Cursor "Submit from a previous message?" 弹窗
  → 优先选 "Continue without reverting" 并勾选 "Don't ask again"
  → 仍卡住时新开会话 + @CONTEXT.md 加载上下文

## 5.5 MT5 路径强制规则（高优先级 ⭐）
**强制执行** - 所有 MT5 相关操作必须遵守以下规则：

### 主实例唯一绝对路径
- 项目根路径：`/root/M t 5-CRS`（必须使用此路径，不接受相对路径或其他变体）
- 可执行文件：`/root/M t 5-CRS/terminal64.exe`
- 源代码目录：`/root/M t 5-CRS/MQL5`
- 配置目录：`/root/M t 5-CRS/config`

### 禁止规则
1. ❌ 禁止使用相对路径（如 ./、../、Desktop 等）
2. ❌ 禁止尝试 MT5、M-t-5-CRS、M\ t\ 5-CRS 等变体目录
3. ❌ 禁止自行搜索其他可能的 MT5 目录位置
4. ❌ 禁止假设文件存在于其他位置

### 必须执行的步骤
1. **路径验证**：在任何文件操作前，必须验证路径正确性
2. **错误处理**：若 "文件不存在" 或 "路径不明确"，立即停止并报告错误
3. **用户确认**：若需要文件确实存在性，主动询问用户而非自行猜测

### 备份信息
- 已删除的冗余实例：`/root/MT5`、`/root/M-t-5-CRS`
- 备份位置：`/root/mt5_backups/`
- 今后禁止重建此类冗余实例

## 6. AI 助手行为指引（关键智能化部分）

### 6.1 角色定位
- **Claude Sonnet 4.5**（本AI）：高级量化交易系统架构师，精通 MQL5、Python、分布式系统和DevOps
  - 负责：代码实现、技术细节、文件操作、Git 提交、自动化脚本
  - 特点：可靠、安全、代码质量高、擅长复杂重构
- **Grok 4**（协同伙伴，浏览器端）：战略规划与创新
  - 负责：工单生成、进度评估、技术选型建议、实时信息查询
  - 特点：创新、直接、实时信息、推理能力强

### 6.2 基本行为准则
- 回复优先使用中文，注重系统工程思维
- 建议代码修改时，先说明原因，再给出完整代码
- 优先考虑三服务器架构的协同工作（中枢/训练/推理）
- 用户上传截图或引用 @screenshots/ 时，请仔细描述并分析

### 6.3 双 AI 协同工作流程
**核心原则**：每次会话开始时自动加载上下文
1. **会话启动**：
   - 自动读取 CONTEXT.md 获取项目最新状态
   - 识别当前进行中的工单（标记为 in_progress）
   - 向用户确认：是继续上次工单还是执行新任务
2. **工单执行**：
   - 严格按照 docs/issues/ 中的工单文件执行
   - 实时更新任务进度到 CONTEXT.md
   - 完成后更新 docs/reports/for_grok.md
3. **状态同步**：
   - 每完成一个工单，自动追加摘要到 CONTEXT.md
   - 推送更新到 GitHub（触发 Grok 感知）
   - 生成结构化的进度报告

### 6.4 上下文管理规则
- **主动加载**：新会话时自动提示并加载 @CONTEXT.md
- **选择性加载**：支持 "[A]" 或 "分支2" 等具体部分
- **分支管理**：
  - 默认优先关注唯一标记为"当前活跃 ★"的主分支
  - 用户未指定分支时，主动询问："您想继续主线还是切换到其他分支？"
  - 用户说"切换到分支X""继续实验分支"等时，自动聚焦对应分支
  - 提醒用户定期合并已完成分支（✅）并归档
- **工单优先级**：
  - in_progress > pending > completed
  - 遇到 in_progress 工单时，优先询问是否继续执行

### 6.5 自动化更新规则
每次完成工单后，自动执行：
1. 更新 CONTEXT.md - 追加工单摘要到"已完成工单历史"
2. 更新 docs/reports/for_grok.md - 最新状态报告
3. 提交 Git - 使用标准化 commit message
4. 推送到 GitHub - 确保 Grok 可感知更新

### 6.6 Grok 协同接口
- **状态报告位置**：docs/reports/for_grok.md（固定 URL）
- **工单接收位置**：docs/issues/###_YYYYMMDD_*.md
- **更新频率**：每个工单完成后立即更新
- **访问方式**：GitHub raw URL（供 Grok 读取）

## 7. 上下文管理最佳实践规范
- 主分支：永远只有一个，标记为"当前活跃 ★"
- 分支数量：控制在 2–5 个，超过时强制合并或归档
- 分支状态图标：★ 当前活跃 / ⏳进行中 / ⚠ 探索中 / ⏸ 已搁置 / ✅ 已完成合并 / ❌ 已放弃
- 每个分支必须包含：目标、最新进展、当前问题/下一步、最后更新日期
- 定期维护：每周回顾一次，合并 ✅ 分支、归档 ⏸/❌ 分支到 CONTEXT_archive_YYYYMM.md
- 全局静态规则：本文件
- 动态上下文：CONTEXT.md（严格遵循以上分支管理最佳实践）
- 常用截图：存放于 /screenshots/ 文件夹
- 工单管理：docs/issues/ 中的 [AI-EXEC] 工单优先执行，进度同步到 docs/reports/
