# ğŸš€ Gemini Pro å¿«é€ŸååŒé“¾æ¥

> **æœ€æ–°æ›´æ–°**: 2025-12-20 - å·¥å• #010.5 å®Œæˆ (Critical Hotfix - Kelly å…¬å¼ä¿®æ­£ + å¹¶è¡ŒåŒ–)

---

## ğŸ“Š é¡¹ç›®çŠ¶æ€æ€»è§ˆ

| å·¥å• | çŠ¶æ€ | å®Œæˆåº¦ | ä»£ç é‡ | è¯´æ˜ |
|------|------|--------|--------|------|
| **#008** | âœ… å®Œæˆ | 100% | 14,500+ è¡Œ | æ•°æ®ç®¡çº¿ + 75ç»´ç‰¹å¾å·¥ç¨‹ |
| **#009** | âœ… å®Œæˆ | 100% | 2,700+ è¡Œ | å¯¹å†²åŸºé‡‘çº§MLé¢„æµ‹å¼•æ“ |
| **#010** | âœ… å®Œæˆ | 100% | 1,650+ è¡Œ | ç­–ç•¥å›æµ‹å¼•æ“ä¸é£é™©ç®¡ç† |
| **#010.5** | âœ… å®Œæˆ | 100% | 1,530+ è¡Œ | **Hotfix: Kellyä¿®æ­£+å¹¶è¡ŒåŒ–+DSR** ğŸ”¥ |
| **#011** | â¸ï¸ å¾…å¼€å§‹ | 0% | - | å®ç›˜äº¤æ˜“ç³»ç»Ÿ (MT5 API) |

**æ€»ä»£ç é‡**: **20,380+ è¡Œ** (ç”Ÿäº§çº§è´¨é‡)

---

## ğŸ”¥ å·¥å• #010.5 æ ¸å¿ƒä¿®å¤ (Critical Hotfix - åˆšå®Œæˆ!)

### ä¸‰å¤§å…³é”®ä¿®å¤ âœ…

**1. Kelly Criterion æ•°å­¦ä¿®æ­£** ğŸ¯
- **é—®é¢˜**: æ—§å…¬å¼å‡è®¾ 1:1 ç›ˆäºæ¯”ï¼Œå¯¼è‡´è¶‹åŠ¿ç­–ç•¥ï¼ˆä½èƒœç‡é«˜èµ”ç‡ï¼‰å¼ºåˆ¶ç©ºä»“
- **ä¿®å¤**: å®ç°é€šç”¨ Kelly å…¬å¼ `f* = [p(b+1) - 1] / b`
- **å½±å“**: ç­–ç•¥ä»"éšæ€§äºæŸ 0%"æ¢å¤åˆ°æ­£å¸¸æ•æ‰è¶‹åŠ¿æœºä¼š
- **éªŒè¯**: P=0.45, b=2.0 â†’ æ—§å…¬å¼=-2.5âŒ â†’ æ–°å…¬å¼=+0.175âœ…

**2. Walk-Forward å›æµ‹å¹¶è¡ŒåŒ–** âš¡
- **å®ç°**: ProcessPoolExecutor å¤šè¿›ç¨‹å¹¶è¡Œ
- **æ€§èƒ½**: å¤§æ•°æ®é›†é¢„æœŸ 4-8x åŠ é€Ÿ
- **æ¶æ„**: é¡¶å±‚å‡½æ•° run_single_fold() é¿å… Pickle é—®é¢˜

**3. DSR è¯•éªŒè®¡æ•°æŒä¹…åŒ–** ğŸ“Š
- **åŠŸèƒ½**: å…¨å±€è¯•éªŒæ³¨å†Œè¡¨ï¼ˆtrial_registry.jsonï¼‰
- **ä¸¥è°¨æ€§**: ç¬¦åˆ Bailey & LÃ³pez de Prado (2014) å­¦æœ¯æ ‡å‡†
- **æ£€æµ‹**: æœ‰æ•ˆè¯†åˆ«è¿‡æ‹Ÿåˆï¼ˆSR=2.0, N=1000 â†’ DSR=0.000ï¼‰

**è¯¦ç»†æŠ¥å‘Š**: `docs/issues/ISSUE_010.5_COMPLETION_REPORT.md` (731è¡Œ)

---

## ğŸ¯ å·¥å• #010 æ ¸å¿ƒæˆå°±

### 12 å¤§æ ¸å¿ƒåŠŸèƒ½ âœ…

1. **Backtrader äº‹ä»¶é©±åŠ¨å›æµ‹** - ç²¾ç¡®æ¨¡æ‹Ÿ K çº¿å†…è®¢å•æˆäº¤
2. **Kelly Criterion** - åŸºäºé¢„æµ‹æ¦‚ç‡çš„åŠ¨æ€ä»“ä½ç®¡ç†
3. **Deflated Sharpe Ratio (DSR)** - ä¿®æ­£å¤šé‡æµ‹è¯•åå·®
4. **Walk-Forward éªŒè¯** - æ—¶é—´åºåˆ—åˆ†å‰²é¿å…è¿‡æ‹Ÿåˆ
5. **çœŸå®äº¤æ˜“æˆæœ¬æ¨¡æ‹Ÿ** - ç‚¹å·® + æ‰‹ç»­è´¹ + æ»‘ç‚¹
6. **ä¹°å…¥æŒæœ‰åŸºå‡†å¯¹æ¯”** - éªŒè¯ç­–ç•¥æœ‰æ•ˆæ€§
7. **ATR åŠ¨æ€æ­¢æŸæ­¢ç›ˆ** - è‡ªé€‚åº”é£é™©ç®¡ç†
8. **ç§»åŠ¨æ­¢æŸ** - é”å®šåˆ©æ¶¦
9. **è´¦æˆ·çº§é£é™©ç›‘æ§** - ç†”æ–­æœºåˆ¶
10. **HTML äº¤äº’å¼æŠ¥å‘Š** - ä¸“ä¸šå¯è§†åŒ–
11. **ç´¯è®¡æ”¶ç›Šæ›²çº¿** - ç›´è§‚å±•ç¤ºç­–ç•¥è¡¨ç°
12. **æœˆåº¦æ”¶ç›Šçƒ­åŠ›å›¾** - è¯†åˆ«å­£èŠ‚æ€§æ¨¡å¼

### æŠ€æœ¯æ¶æ„

```
ML æ¨¡å‹é¢„æµ‹
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç­–ç•¥å¼•æ“ (MLStrategy)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é¢„æµ‹æ¦‚ç‡ > 0.65 â†’ ä¿¡å· â”‚  â”‚
â”‚  â”‚ ATR åŠ¨æ€æ­¢æŸæ­¢ç›ˆ       â”‚  â”‚
â”‚  â”‚ ç§»åŠ¨æ­¢æŸé”å®šåˆ©æ¶¦       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é£é™©ç®¡ç† (KellySizer)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Kelly = (P-0.5)/Ïƒ      â”‚  â”‚
â”‚  â”‚ Position = Kelly * 0.25â”‚  â”‚
â”‚  â”‚ æœ€å¤§ä»“ä½: 20%          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backtrader å›æµ‹å¼•æ“         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ äº‹ä»¶é©±åŠ¨æ‰§è¡Œ           â”‚  â”‚
â”‚  â”‚ çœŸå®æˆæœ¬æ¨¡æ‹Ÿ           â”‚  â”‚
â”‚  â”‚ K çº¿å†…è®¢å•è§¦å‘         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŠ¥å‘Šç”Ÿæˆ (TearSheet)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Deflated Sharpe Ratio  â”‚  â”‚
â”‚  â”‚ HTML äº¤äº’å¼æŠ¥å‘Š        â”‚  â”‚
â”‚  â”‚ æ€§èƒ½æŒ‡æ ‡å¯è§†åŒ–         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ ¸å¿ƒæ–‡æ¡£ (ä¼˜å…ˆé˜…è¯»)

### 1. å·¥å• #010.5 å®ŒæˆæŠ¥å‘Š â­â­â­â­ (æœ€æ–°! Critical!)
**æ–‡ä»¶**: `docs/issues/ISSUE_010.5_COMPLETION_REPORT.md`

**å†…å®¹**:
- ğŸ”¥ Kelly å…¬å¼æ•°å­¦ä¿®æ­£ï¼ˆé€šç”¨å…¬å¼æ¨å¯¼ä¸éªŒè¯ï¼‰
- âš¡ Walk-Forward å¹¶è¡ŒåŒ–ï¼ˆProcessPoolExecutor å®ç°ï¼‰
- ğŸ“Š DSR è¯•éªŒè®¡æ•°æŒä¹…åŒ–ï¼ˆå­¦æœ¯æ ‡å‡†ï¼‰
- ğŸ“ˆ å®Œæ•´çš„æ•°å­¦éªŒè¯ä¸æµ‹è¯•ç”¨ä¾‹
- ğŸ¯ æŠ€æœ¯äº®ç‚¹åˆ†æï¼ˆ4å¤§æ ¸å¿ƒï¼‰

**å»ºè®®**: **å¿…è¯»ï¼** è¿™æ˜¯å…³é”®æ€§ Hotfixï¼Œè§£é™¤äº†å·¥å• #011 çš„é˜»å¡

---

### 2. å·¥å• #010 å®ŒæˆæŠ¥å‘Š â­â­â­
**æ–‡ä»¶**: `docs/issues/ISSUE_010_COMPLETION_REPORT.md`

**å†…å®¹**:
- âœ… 4 å¤§æ¨¡å—è¯¦è§£ (ç­–ç•¥/é£é™©/å›æµ‹/æŠ¥å‘Š)
- ğŸ“Š 1,650 è¡Œä»£ç ç»Ÿè®¡
- ğŸ“ 4 å¤§æŠ€æœ¯äº®ç‚¹ (Kelly/DSR/äº‹ä»¶é©±åŠ¨/Walk-Forward)
- ğŸ“ˆ éªŒæ”¶æ ‡å‡† (4/4 = 100% é€šè¿‡)
- ğŸš€ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

**å»ºè®®**: äº†è§£å›æµ‹ç³»ç»Ÿçš„å…¥å£æ–‡æ¡£

---

### 3. å›æµ‹å¼•æ“ä½¿ç”¨æŒ‡å— â­â­â­
**æ–‡ä»¶**: `docs/BACKTEST_GUIDE.md`

**å†…å®¹**:
- ğŸ¯ ç³»ç»Ÿæ¦‚è§ˆä¸æ ¸å¿ƒç‰¹æ€§
- ğŸš€ 3 ç§å›æµ‹æ¨¡å¼ (åŸºç¡€/åŸºå‡†å¯¹æ¯”/Walk-Forward)
- ğŸ”§ é«˜çº§é…ç½® (äº¤æ˜“æˆæœ¬/ç­–ç•¥å‚æ•°/Kelly Sizer)
- ğŸ“Š DSR è¯¦ç»†è¯´æ˜ä¸è§£é‡Š
- ğŸ›¡ï¸ é£é™©ç®¡ç†æœºåˆ¶
- ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**å»ºè®®**: æƒ³ä½¿ç”¨å›æµ‹ç³»ç»Ÿï¼Œå¿…è¯»æ­¤æ–‡æ¡£

---

### 4. å·¥å• #009 å®ŒæˆæŠ¥å‘Š â­â­â­
**æ–‡ä»¶**: `docs/issues/ISSUE_009_COMPLETION_REPORT.md`

**å†…å®¹**:
- âœ… 8 å¤§äº¤ä»˜ç‰©è¯¦è§£
- ğŸ“Š 2,700+ è¡Œä»£ç ç»Ÿè®¡
- ğŸ“ 5 å¤§æŠ€æœ¯äº®ç‚¹ (Purged K-Fold/Ensemble Stacking ç­‰)
- ğŸ“ˆ éªŒæ”¶æ ‡å‡† (10/10 é€šè¿‡)

---

### 5. æœºå™¨å­¦ä¹ é«˜çº§è®­ç»ƒæŒ‡å— â­â­
**æ–‡ä»¶**: `docs/ML_ADVANCED_GUIDE.md`

**å†…å®¹**:
- ğŸ¯ Purged K-Fold è¯¦ç»†åŸç†
- ğŸ“ Clustered Feature Importance æ•°å­¦æ¨å¯¼
- ğŸ¤– Ensemble Stacking æ¶æ„è¯¦è§£

---

## ğŸ’» å…³é”®ä»£ç æ–‡ä»¶ (Gemini å®¡æŸ¥é‡ç‚¹)

### é£é™©ç®¡ç†å™¨ â­â­â­â­ (æœ€æ–°ä¿®æ­£! Critical!)
**æ–‡ä»¶**: [src/strategy/risk_manager.py](src/strategy/risk_manager.py)
**ä»£ç é‡**: 335 è¡Œ
**ä¿®æ”¹**: å·¥å• #010.5 æ ¸å¿ƒä¿®å¤

**Kelly å…¬å¼å®ç°** (å·²ä¿®æ­£):
```python
class KellySizer(bt.Sizer):
    def _getsizing(self, comminfo, cash, data, isbuy):
        # è·å–é¢„æµ‹æ¦‚ç‡
        p_win = data.y_pred_proba_long[0]

        # è·å–èµ”ç‡ b (ç›ˆäºæ¯”)
        b = self.strategy.params.take_profit_ratio  # é»˜è®¤ 2.0

        # ============================================================
        # é€šç”¨ Kelly å…¬å¼ï¼šf* = [p(b+1) - 1] / b
        # ============================================================
        kelly_f = (p_win * (b + 1) - 1) / b

        if kelly_f <= 0:
            return 0  # æœŸæœ›å€¼ä¸ºè´Ÿï¼Œä¸å¼€ä»“

        # åº”ç”¨å®‰å…¨è¾¹é™… (å››åˆ†ä¹‹ä¸€ Kelly)
        risk_pct = kelly_f * 0.25

        # è®¡ç®—ä»“ä½ï¼šä»"é£é™©æ¯”ä¾‹"è½¬æ¢ä¸º"æŒä»“æ•°é‡"
        risk_amount = account_value * risk_pct
        risk_per_share = atr_value * 2.0  # æ­¢æŸè·ç¦»
        target_shares = risk_amount / risk_per_share

        # é™åˆ¶æŒä»“æ¯”ä¾‹ [1%, 50%]
        return int(target_shares)
```

**ä¿®æ­£è¦ç‚¹**:
1. âœ… æ—§å…¬å¼ `(p - 0.5) / vol` â†’ æ–°å…¬å¼ `[p(b+1) - 1] / b`
2. âœ… æ”¯æŒä»»æ„ç›ˆäºæ¯”ï¼ˆä¸å†å‡è®¾ b=1ï¼‰
3. âœ… æ­£ç¡®åŒºåˆ†"é£é™©æ¯”ä¾‹"ä¸"æŒä»“æ¯”ä¾‹"
4. âœ… å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œè¾¹ç•Œæ£€æŸ¥

**Gemini å®¡æŸ¥é‡ç‚¹**:
- [ ] æ–°å…¬å¼å®ç°æ˜¯å¦å®Œå…¨æ­£ç¡®?
- [ ] é£é™©æ¯”ä¾‹åˆ°æŒä»“æ•°é‡çš„è½¬æ¢é€»è¾‘æ˜¯å¦åˆç†?
- [ ] æ˜¯å¦éœ€è¦è€ƒè™‘æ æ†å› å­?

---

### å›æµ‹å¼•æ“ â­â­â­ (å·²å‡çº§!)
**æ–‡ä»¶**: [bin/run_backtest.py](bin/run_backtest.py)
**ä»£ç é‡**: 545 è¡Œ (æ–°å¢å¹¶è¡ŒåŒ–)
**ä¿®æ”¹**: å·¥å• #010.5 å¹¶è¡ŒåŒ–å‡çº§

**æ ¸å¿ƒç±»**:
1. `BacktestRunner` - å›æµ‹æ‰§è¡Œå™¨
2. `MLDataFeed` - è‡ªå®šä¹‰æ•°æ®æº

**æ–°å¢åŠŸèƒ½** (å¹¶è¡ŒåŒ–):
```python
def run_single_fold(fold_num, test_df, train_dates, test_dates, config):
    """é¡¶å±‚å‡½æ•° - åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œå•ä¸ªçª—å£çš„å›æµ‹"""
    cerebro = bt.Cerebro()  # æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹åˆ›å»º
    cerebro.addstrategy(MLStrategy)
    # ... é…ç½® ...
    return fold_result

class BacktestRunner:
    def run_walkforward(self, df, parallel=True, max_workers=None):
        # å¹¶è¡Œæ‰§è¡Œ
        with ProcessPoolExecutor(max_workers=max_workers) as executor:
            futures = {
                executor.submit(run_single_fold, fold, df, ...)
                for fold in folds
            }
            results = [f.result() for f in as_completed(futures)]
```

**å¹¶è¡ŒåŒ–ä¼˜åŠ¿**:
- âœ… å¤§æ•°æ®é›†é¢„æœŸ 4-8x åŠ é€Ÿ
- âœ… å®¹é”™æœºåˆ¶ï¼ˆå•ä¸ªçª—å£å¤±è´¥ä¸å½±å“å…¶ä»–ï¼‰
- âœ… å®æ—¶è¿›åº¦åé¦ˆ

**Gemini å®¡æŸ¥é‡ç‚¹**:
- [ ] å¹¶è¡ŒåŒ–å®ç°æ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶?
- [ ] DataFrame ä¼ é€’æ˜¯å¦ä¼šå¯¼è‡´å†…å­˜é—®é¢˜?
- [ ] æ˜¯å¦éœ€è¦å®ç°ä»»åŠ¡é˜Ÿåˆ—ä¼˜åŒ–?

---

### ML ç­–ç•¥é€‚é…å™¨ â­â­â­ (æœ€æ–°!)
**æ–‡ä»¶**: [src/strategy/ml_strategy.py](src/strategy/ml_strategy.py)
**ä»£ç é‡**: 260 è¡Œ

**æ ¸å¿ƒç±»**:
1. `MLStrategy` - ML é©±åŠ¨çš„äº¤æ˜“ç­–ç•¥
2. `BuyAndHoldStrategy` - ä¹°å…¥æŒæœ‰åŸºå‡†

**æ ¸å¿ƒé€»è¾‘**:
```python
class MLStrategy(bt.Strategy):
    params = (
        ('threshold_long', 0.65),       # åšå¤šé˜ˆå€¼
        ('atr_stop_multiplier', 2.0),   # æ­¢æŸå€æ•°
        ('take_profit_ratio', 2.0),     # æ­¢ç›ˆ/æ­¢æŸæ¯”ç‡
        ('enable_trailing_stop', True), # ç§»åŠ¨æ­¢æŸ
    )

    def next(self):
        # ä¿¡å·æ£€æµ‹
        if self.position:
            # å‡ºåœºé€»è¾‘ï¼šæ­¢æŸ/æ­¢ç›ˆ/æœ€å¤§æŒä»“å‘¨æœŸ
            if current_price <= self.stop_loss:
                self.close()
        else:
            # å…¥åœºé€»è¾‘ï¼šé¢„æµ‹æ¦‚ç‡ > é˜ˆå€¼
            if y_pred_long > self.params.threshold_long:
                self.buy()
```

**å®¡æŸ¥é‡ç‚¹**:
- [ ] æ­¢æŸæ­¢ç›ˆé€»è¾‘æ˜¯å¦å­˜åœ¨è¾¹ç•Œæ¡ä»¶ bug?
- [ ] ç§»åŠ¨æ­¢æŸå®ç°æ˜¯å¦æ­£ç¡®?
- [ ] å¤šç©ºåˆ‡æ¢æ˜¯å¦ä¼šå‡ºç°é—®é¢˜?

---

### é£é™©ç®¡ç†å™¨ â­â­â­ (æœ€æ–°!)
**æ–‡ä»¶**: [src/strategy/risk_manager.py](src/strategy/risk_manager.py)
**ä»£ç é‡**: 330 è¡Œ

**æ ¸å¿ƒç±»**:
1. `KellySizer` - Kelly Criterion ä»“ä½ç®¡ç†
2. `DynamicRiskManager` - è´¦æˆ·çº§é£é™©ç›‘æ§

**Kelly å…¬å¼å®ç°**:
```python
class KellySizer(bt.Sizer):
    def _getsizing(self, comminfo, cash, data, isbuy):
        # è·å–é¢„æµ‹æ¦‚ç‡
        p_win = data.y_pred_proba_long[0]

        # è®¡ç®—æ³¢åŠ¨ç‡ (ATR)
        atr_value = self.strategy.atr[0]
        normalized_volatility = atr_value / current_price

        # Kelly å…¬å¼å˜ä½“
        kelly_pct = (p_win - 0.5) / normalized_volatility
        kelly_pct = kelly_pct * 0.25  # å››åˆ†ä¹‹ä¸€ Kelly

        # é™åˆ¶èŒƒå›´ [1%, 20%]
        kelly_pct = max(0.01, min(kelly_pct, 0.20))

        return int(account_value * kelly_pct / current_price)
```

**å®¡æŸ¥é‡ç‚¹**:
- [ ] Kelly å…¬å¼å®ç°æ˜¯å¦æ­£ç¡®?
- [ ] æ³¢åŠ¨ç‡å½’ä¸€åŒ–æ˜¯å¦åˆç†?
- [ ] å››åˆ†ä¹‹ä¸€ Kelly æ˜¯å¦è¿‡äºä¿å®ˆ?
- [ ] æ˜¯å¦éœ€è¦åŠ å…¥ Optimal F?

---

### æŠ¥å‘Šç”Ÿæˆå™¨ â­â­â­ (æœ€æ–°!)
**æ–‡ä»¶**: [src/reporting/tearsheet.py](src/reporting/tearsheet.py)
**ä»£ç é‡**: 460 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. **Deflated Sharpe Ratio è®¡ç®—**
2. HTML äº¤äº’å¼æŠ¥å‘Šç”Ÿæˆ
3. ç´¯è®¡æ”¶ç›Šæ›²çº¿ã€å›æ’¤åˆ†æã€æœˆåº¦çƒ­åŠ›å›¾

**DSR å…¬å¼å®ç°**:
```python
def calculate_deflated_sharpe_ratio(
    observed_sr, n_trials, n_observations, skewness, kurtosis
):
    # 1. æœŸæœ›æœ€å¤§ SR (åŸºäºæå€¼ç†è®º)
    expected_max_sr = sqrt(2*log(n_trials)) - ...

    # 2. SR æ ‡å‡†å·® (è€ƒè™‘éæ­£æ€æ€§)
    sr_variance = (
        1.0 - skewness * observed_sr
        + ((kurtosis - 3.0) / 4.0) * (observed_sr ** 2)
    ) / n_observations

    # 3. Deflated SR
    dsr = (observed_sr - expected_max_sr) / sqrt(sr_variance)

    # 4. p-value
    dsr_pvalue = 1.0 - stats.norm.cdf(dsr)

    return dsr
```

**å®¡æŸ¥é‡ç‚¹**:
- [ ] DSR å…¬å¼å®ç°æ˜¯å¦æ­£ç¡®?
- [ ] æå€¼æœŸæœ›å…¬å¼æ˜¯å¦æœ‰æ›´ç²¾ç¡®çš„ç‰ˆæœ¬?
- [ ] éæ­£æ€æ€§è°ƒæ•´æ˜¯å¦å……åˆ†?
- [ ] æ˜¯å¦éœ€è¦ Bootstrap éªŒè¯?

---

### éªŒè¯å™¨æ¨¡å— â­â­â­
**æ–‡ä»¶**: [src/models/validation.py](src/models/validation.py)
**ä»£ç é‡**: 297 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
```python
class PurgedKFold:
    """é˜²æ­¢ä¿¡æ¯æ³„æ¼çš„äº¤å‰éªŒè¯å™¨"""

    def _purge_train_set(self, train_idx, test_idx, event_ends):
        # åˆ é™¤è®­ç»ƒé›†ä¸­ä¸æµ‹è¯•é›†æ ‡ç­¾é‡å çš„æ ·æœ¬
        test_start = event_ends.iloc[test_idx].min()
        overlap_mask = train_event_ends >= test_start
        return train_idx[~overlap_mask]
```

**å®¡æŸ¥é‡ç‚¹**:
- [ ] Purging é€»è¾‘æ˜¯å¦æ­£ç¡®?
- [ ] Embargoing æ¯”ä¾‹ (1%) æ˜¯å¦åˆç†?

---

### è®­ç»ƒå™¨æ¨¡å— â­â­â­
**æ–‡ä»¶**: [src/models/trainer.py](src/models/trainer.py)
**ä»£ç é‡**: 896 è¡Œ

**æ ¸å¿ƒç±»**:
1. `LightGBMTrainer`
2. `CatBoostTrainer`
3. `EnsembleStacker`
4. `OptunaOptimizer`

**å®¡æŸ¥é‡ç‚¹**:
- [ ] Ensemble Stacking å®ç°æ˜¯å¦æ­£ç¡®?
- [ ] Out-of-Fold é¢„æµ‹æ˜¯å¦é˜²æ­¢ä¿¡æ¯æ³„æ¼?

---

## ğŸ¯ Gemini Pro å¯ä»¥å¸®åŠ©çš„ 3 ä»¶äº‹

### 1. Kelly å…¬å¼ä¿®æ­£éªŒè¯ â­â­â­â­ (æœ€éœ€è¦! ğŸ”¥)

**å·²ä¿®æ­£çš„å…¬å¼**:
```
æ—§: kelly_pct = (p - 0.5) / vol  (å‡è®¾ b=1)
æ–°: f* = [p(b+1) - 1] / b         (é€šç”¨å…¬å¼)
```

**Gemini æ·±åº¦å®¡æŸ¥**:
1. **æ•°å­¦ä¸¥è°¨æ€§éªŒè¯**:
   - [ ] é€šç”¨ Kelly å…¬å¼æ¨å¯¼æ˜¯å¦å®Œå…¨æ­£ç¡®?
   - [ ] é£é™©æ¯”ä¾‹ f* åˆ°æŒä»“æ•°é‡çš„è½¬æ¢é€»è¾‘æ˜¯å¦åˆç†?
   - [ ] æ˜¯å¦éœ€è¦è€ƒè™‘æ æ†è°ƒæ•´?

2. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**:
   - [ ] P=0.33, b=2.0 (æœŸæœ›å€¼=0) â†’ f*åº”ä¸ºè´Ÿæˆ–é›¶ âœ“
   - [ ] P=0.45, b=2.0 (è¶‹åŠ¿ç­–ç•¥) â†’ f*=0.175 æ˜¯å¦åˆç†?
   - [ ] P=0.60, b=1.0 (é«˜èƒœç‡) â†’ æ–°æ—§å…¬å¼æ˜¯å¦ä¸€è‡´?

3. **å®è·µå»ºè®®**:
   - [ ] å››åˆ†ä¹‹ä¸€ Kelly (0.25) æ˜¯å¦è¿‡äºä¿å®ˆ? å»ºè®®å€¼?
   - [ ] æ˜¯å¦éœ€è¦æ ¹æ®å¸‚åœºæ³¢åŠ¨åŠ¨æ€è°ƒæ•´ kelly_fraction?
   - [ ] æ˜¯å¦éœ€è¦å¼•å…¥ Optimal F ä½œä¸ºå¯¹æ¯”?

**å‚è€ƒæ–‡çŒ®**:
- Kelly, J. L. (1956). "A New Interpretation of Information Rate"
- Thorp, E. O. (2008). "The Kelly Criterion in Blackjack Sports Betting"

---

### 2. å¹¶è¡ŒåŒ–æ¶æ„ä¼˜åŒ– â­â­â­ (å·²å®ç°ï¼Œå¾…å®¡æŸ¥)

**å·²å®ç°**:
- âœ… ProcessPoolExecutor å¤šè¿›ç¨‹å¹¶è¡Œ
- âœ… é¡¶å±‚å‡½æ•°é¿å… Pickle åºåˆ—åŒ–é—®é¢˜
- âœ… å®¹é”™æœºåˆ¶ï¼ˆå•çª—å£å¤±è´¥ä¸å½±å“æ•´ä½“ï¼‰

**Gemini å®¡æŸ¥**:
1. **æ€§èƒ½åˆ†æ**:
   - [ ] å°æ•°æ®é›†å¹¶è¡Œåè€Œæ›´æ…¢ï¼ˆè¿›ç¨‹å¼€é”€ï¼‰æ˜¯å¦éœ€è¦è‡ªåŠ¨é™çº§?
   - [ ] å¤§æ•°æ®é›†é¢„æœŸ 4-8x åŠ é€Ÿï¼Œå®é™…èƒ½è¾¾åˆ°å—?
   - [ ] æ˜¯å¦éœ€è¦å®ç°ä»»åŠ¡é˜Ÿåˆ—ï¼ˆé¿å… DataFrame é‡å¤ä¼ é€’ï¼‰?

2. **æ¶æ„ä¼˜åŒ–**:
   - [ ] æ˜¯å¦éœ€è¦å¼•å…¥ Dask/Ray è¿›è¡Œåˆ†å¸ƒå¼å›æµ‹?
   - [ ] æ˜¯å¦å¯ä»¥å®ç°å¢é‡å›æµ‹ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰?
   - [ ] æ˜¯å¦éœ€è¦æ·»åŠ å›æµ‹ç¼“å­˜æœºåˆ¶?

3. **å…¶ä»–ä¼˜åŒ–æ–¹å‘**:
   - [ ] Numba JIT ç¼–è¯‘ç‰¹å¾è®¡ç®—å‡½æ•°
   - [ ] Cython é‡å†™æ€§èƒ½ç“¶é¢ˆä»£ç 
   - [ ] å‘é‡åŒ–æ“ä½œæ›¿ä»£å¾ªç¯

---

### 3. å·¥å• #011 è§„åˆ’å»ºè®® â­â­

**ä¸‹ä¸€æ­¥**: å®ç›˜äº¤æ˜“ç³»ç»Ÿ (MT5 API å¯¹æ¥)

**æ ¸å¿ƒé—®é¢˜**:
1. å¦‚ä½•å°†å›æµ‹ç­–ç•¥æ— ç¼è¿ç§»åˆ°å®ç›˜?
2. å®ç›˜é£é™©ç®¡ç†éœ€è¦å“ªäº›é¢å¤–æœºåˆ¶?
3. å¦‚ä½•ç›‘æ§æ¨¡å‹æ¼‚ç§» (Model Drift)?
4. å¦‚ä½•å¤„ç†æ–­çº¿é‡è¿ã€è®¢å•å¤±è´¥ç­‰å¼‚å¸¸?
5. å¦‚ä½•å®ç°å¤šå“ç§ã€å¤šç­–ç•¥å¹¶è¡Œäº¤æ˜“?

**æœŸæœ›è¾“å‡º**:
- å®ç›˜äº¤æ˜“ç³»ç»Ÿæ¶æ„è®¾è®¡
- MT5 API é›†æˆæ–¹æ¡ˆ
- å…³é”®ç»„ä»¶æ¸…å•ä¸ä¼˜å…ˆçº§

---

## ğŸ“Š é¡¹ç›®ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **æ€»ä»£ç é‡** | 20,380+ è¡Œ |
| **å·¥å•å®Œæˆ** | 3.5/5 (70%) |
| **ç‰¹å¾ç»´åº¦** | 75 ç»´ |
| **å›æµ‹åŠŸèƒ½** | 12 é¡¹ |
| **éªŒè¯ç­–ç•¥** | Purged K-Fold / Walk-Forward (å¹¶è¡Œ) |
| **é£é™©ç®¡ç†** | Kelly Criterion (é€šç”¨å…¬å¼) + ç†”æ–­ |
| **æ€§èƒ½æŒ‡æ ‡** | 10+ ä¸ª (Sharpe, DSR, Calmar ç­‰) |
| **å¹¶è¡ŒåŠ é€Ÿ** | 4-8x (å¤§æ•°æ®é›†) |
| **æµ‹è¯•æ–‡ä»¶** | 95+ æµ‹è¯•æ–¹æ³• |

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### å›æµ‹ç³»ç»Ÿæµ‹è¯•

```bash
# 1. åŸºç¡€å›æµ‹
python bin/run_backtest.py --symbol EURUSD --start-date 2024-01-01 --end-date 2024-12-31

# 2. åŸºå‡†å¯¹æ¯”
python bin/run_backtest.py --symbol EURUSD --benchmark

# 3. Walk-Forward éªŒè¯
python bin/run_backtest.py --symbol EURUSD --walk-forward

# 4. è‡ªå®šä¹‰äº¤æ˜“æˆæœ¬
python bin/run_backtest.py --commission 0.0003 --spread 0.0003 --slippage 0.001

# 5. æŸ¥çœ‹ç»“æœ
ls backtest_results/
```

### å®Œæ•´æµç¨‹æµ‹è¯•

```bash
# 1. ç”Ÿæˆç¤ºä¾‹æ•°æ®
python bin/generate_sample_data.py

# 2. è®­ç»ƒ ML æ¨¡å‹
python bin/train_ml_model.py

# 3. ç”Ÿæˆé¢„æµ‹
python bin/train_ml_model.py --predict

# 4. è¿è¡Œå›æµ‹
python bin/run_backtest.py --symbol EURUSD
```

---

## ğŸ“– ç†è®ºåŸºç¡€

### å¿…è¯»ä¹¦ç±
1. **ã€ŠAdvances in Financial Machine Learningã€‹** - Marcos Lopez de Prado
   - Chapter 7: Cross-Validation in Finance (Purged K-Fold)
   - Chapter 8: Feature Importance (MDA, Clustered Importance)
   - Chapter 10: Bet Sizing (Kelly Criterion)
   - Chapter 11: The Dangers of Backtesting (Deflated Sharpe Ratio)

2. **ã€ŠQuantitative Tradingã€‹** - Ernest P. Chan
   - Chapter 6: Backtesting Strategies
   - Chapter 7: Automated Trading Systems

### è®ºæ–‡å‚è€ƒ
1. **Deflated Sharpe Ratio**: Bailey & LÃ³pez de Prado (2014)
2. **Kelly Criterion**: Kelly (1956)
3. **Purged K-Fold**: LÃ³pez de Prado (2018)

---

## ğŸ’¬ ååŒå·¥ä½œæµ

1. **Gemini é˜…è¯»** ğŸ“–
   - ä¼˜å…ˆé˜…è¯»: ISSUE_010_COMPLETION_REPORT.md
   - æ·±å…¥ç†è§£: BACKTEST_GUIDE.md
   - ä»£ç å®¡æŸ¥: run_backtest.py, ml_strategy.py, risk_manager.py, tearsheet.py

2. **Gemini åé¦ˆ** ğŸ’¬
   - æŒ‡å‡ºæ½œåœ¨ bug (ç‰¹åˆ«æ˜¯ Kelly/DSR å…¬å¼)
   - æä¾›æ€§èƒ½ä¼˜åŒ–å»ºè®®
   - ç»™å‡ºå·¥å• #011 è§„åˆ’æ€è·¯

3. **Claude å®æ–½** âš¡
   - æ ¹æ® Gemini å»ºè®®ä¿®æ”¹ä»£ç 
   - ä¼˜åŒ–å›æµ‹æ€§èƒ½
   - å‡†å¤‡å®ç›˜ç³»ç»Ÿå¼€å‘

4. **è¿­ä»£ä¼˜åŒ–** ğŸ”„
   - Gemini å®¡æŸ¥ä¿®æ”¹åçš„ä»£ç 
   - ç»§ç»­ä¼˜åŒ–ç›´åˆ°æ»¡æ„
   - è¿›å…¥å·¥å• #011

---

## ğŸ“ è”ç³»æ–¹å¼

**GitHub ä»“åº“**: https://github.com/luzhengheng/MT5

å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­æå‡º:
- ä»£ç  bug: [Issues](https://github.com/luzhengheng/MT5/issues)
- åŠŸèƒ½å»ºè®®: [Discussions](https://github.com/luzhengheng/MT5/discussions)

---

**æœ€åæ›´æ–°**: 2025-12-20 13:20 (UTC+8)
**æ›´æ–°äºº**: Claude Sonnet 4.5
**ååŒçŠ¶æ€**: ç­‰å¾… Gemini Pro å®¡æŸ¥å·¥å• #010.5 (Critical Hotfix) â³
**å½“å‰è¿›åº¦**: 3.5/5 å·¥å•å®Œæˆ (70%)
**å…³é”®ä¿®å¤**: âœ… Kelly å…¬å¼ä¿®æ­£ | âœ… å¹¶è¡ŒåŒ– | âœ… DSR æŒä¹…åŒ–
