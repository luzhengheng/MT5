# ç­–ç•¥å›æµ‹å¼•æ“ä½¿ç”¨æŒ‡å—

å·¥å• #010 äº¤ä»˜ç‰© - MT5-CRS ç­–ç•¥å›æµ‹ä¸é£é™©ç®¡ç†ç³»ç»Ÿ

## ğŸ¯ ç³»ç»Ÿæ¦‚è§ˆ

æœ¬å›æµ‹å¼•æ“å°†æœºå™¨å­¦ä¹ æ¨¡å‹çš„é¢„æµ‹æ¦‚ç‡è½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„äº¤æ˜“æŒ‡ä»¤ï¼Œå¹¶é€šè¿‡ä¸¥è°¨çš„äº‹ä»¶é©±åŠ¨å›æµ‹éªŒè¯ç­–ç•¥çš„ç›ˆåˆ©èƒ½åŠ›ã€‚

### æ ¸å¿ƒç‰¹æ€§

1. âœ… **Backtrader äº‹ä»¶é©±åŠ¨æ¶æ„** - ç²¾ç¡®æ¨¡æ‹Ÿ K çº¿å†…éƒ¨è®¢å•æˆäº¤
2. âœ… **Kelly Criterion åŠ¨æ€ä»“ä½ç®¡ç†** - åŸºäºé¢„æµ‹æ¦‚ç‡å’Œå¸‚åœºæ³¢åŠ¨ç‡
3. âœ… **çœŸå®äº¤æ˜“æˆæœ¬æ¨¡æ‹Ÿ** - ç‚¹å·®ã€æ‰‹ç»­è´¹ã€æ»‘ç‚¹
4. âœ… **Deflated Sharpe Ratio (DSR)** - æ¦‚ç‡è°ƒæ•´åçš„å¤æ™®æ¯”ç‡
5. âœ… **Walk-Forward éªŒè¯** - é¿å…è¿‡æ‹Ÿåˆ
6. âœ… **ä¹°å…¥æŒæœ‰åŸºå‡†å¯¹æ¯”** - éªŒè¯ç­–ç•¥æœ‰æ•ˆæ€§

---

## ğŸ“¦ æ¨¡å—ç»“æ„

```
src/
â”œâ”€â”€ strategy/
â”‚   â”œâ”€â”€ ml_strategy.py         # ML ç­–ç•¥é€‚é…å™¨
â”‚   â””â”€â”€ risk_manager.py        # Kelly Sizer + é£é™©ç®¡ç†
â”œâ”€â”€ reporting/
â”‚   â””â”€â”€ tearsheet.py           # å›æµ‹æŠ¥å‘Šç”Ÿæˆå™¨ï¼ˆå« DSRï¼‰
bin/
â””â”€â”€ run_backtest.py            # å›æµ‹ä¸»ç¨‹åº
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€å›æµ‹

```bash
python bin/run_backtest.py \
    --symbol EURUSD \
    --start-date 2024-01-01 \
    --end-date 2024-12-31 \
    --initial-cash 100000
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ç­–ç•¥ç»“æŸ - æœ€ç»ˆè´¦æˆ·ä»·å€¼: $98,167.41
æ€»äº¤æ˜“æ¬¡æ•°: 257
èƒœç‡: 42.4%
```

### 2. å¯¹æ¯”ä¹°å…¥æŒæœ‰ç­–ç•¥

```bash
python bin/run_backtest.py \
    --symbol EURUSD \
    --start-date 2024-01-01 \
    --end-date 2024-12-31 \
    --benchmark
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ML ç­–ç•¥æ”¶ç›Šç‡: -1.83%, Sharpe: -0.07
ä¹°å…¥æŒæœ‰æ”¶ç›Šç‡: 16.20%, Sharpe: 0.29
è¶…é¢æ”¶ç›Š: -18.04%
```

### 3. Walk-Forward éªŒè¯ï¼ˆæ—¶é—´åºåˆ—åˆ†å‰²ï¼‰

```bash
python bin/run_backtest.py \
    --symbol EURUSD \
    --start-date 2023-01-01 \
    --end-date 2024-12-31 \
    --walk-forward
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
çª—å£ 1: æ”¶ç›Šç‡=5.20%, Sharpe=1.02, å›æ’¤=-8.50%
çª—å£ 2: æ”¶ç›Šç‡=-2.10%, Sharpe=-0.30, å›æ’¤=-12.30%
çª—å£ 3: æ”¶ç›Šç‡=3.50%, Sharpe=0.85, å›æ’¤=-6.20%
```

---

## ğŸ”§ é«˜çº§é…ç½®

### è°ƒæ•´äº¤æ˜“æˆæœ¬

```bash
python bin/run_backtest.py \
    --commission 0.0003 \    # æ‰‹ç»­è´¹ 0.03%
    --spread 0.0003 \        # ç‚¹å·® 3 pips
    --slippage 0.001         # æ»‘ç‚¹ 0.1%
```

### ç­–ç•¥å‚æ•°ï¼ˆåœ¨ä»£ç ä¸­ä¿®æ”¹ï¼‰

ç¼–è¾‘ `src/strategy/ml_strategy.py`ï¼š

```python
params = (
    ('threshold_long', 0.70),        # æé«˜åšå¤šé˜ˆå€¼ â†’ å‡å°‘äº¤æ˜“é¢‘ç‡
    ('threshold_short', 0.70),       # æé«˜åšç©ºé˜ˆå€¼
    ('atr_stop_multiplier', 3.0),    # æ”¾å®½æ­¢æŸ â†’ å‡å°‘è¢«æ­¢æŸ
    ('take_profit_ratio', 2.5),      # æé«˜æ­¢ç›ˆæ¯”ä¾‹
    ('max_holding_bars', 30),        # å»¶é•¿æœ€å¤§æŒä»“å‘¨æœŸ
)
```

### Kelly Sizer å‚æ•°

ç¼–è¾‘ `bin/run_backtest.py` çš„ `config`ï¼š

```python
config = {
    'kelly_fraction': 0.25,      # å››åˆ†ä¹‹ä¸€ Kellyï¼ˆä¿å®ˆï¼‰
    'max_position_pct': 0.20,    # å•ç¬”æœ€å¤§ 20% ä»“ä½
}
```

---

## ğŸ“Š ç”Ÿæˆå›æµ‹æŠ¥å‘Šï¼ˆå« DSRï¼‰

### ä½¿ç”¨ TearSheetGenerator

```python
from src.reporting.tearsheet import TearSheetGenerator
import pandas as pd

# 1. å‡†å¤‡æ”¶ç›Šç‡åºåˆ—
returns = pd.Series([0.01, -0.005, 0.02, ...], index=pd.date_range('2024-01-01', periods=100))

# 2. ç”ŸæˆæŠ¥å‘Š
generator = TearSheetGenerator(output_dir='backtest_results')
metrics = generator.generate_report(
    returns=returns,
    n_trials=100,  # âš ï¸ é‡è¦ï¼šOptuna è°ƒå‚æ¬¡æ•°ï¼ˆå½±å“ DSRï¼‰
    strategy_name="ML Strategy v2",
    output_filename="tearsheet_2024.html"
)

# 3. æŸ¥çœ‹ DSR
print(f"DSR: {metrics['dsr']:.3f}")
print(f"æ˜¾è‘—æ€§: {metrics['is_significant']}")
print(f"è§£é‡Š: {metrics['interpretation']}")
```

### DSR è§£é‡Š

| DSR å€¼ | å«ä¹‰ |
|--------|------|
| **â‰¥ 2.0** | ğŸŸ¢ éå¸¸æ˜¾è‘— - ç­–ç•¥ä¼˜å¼‚ï¼Œè¿‡æ‹Ÿåˆé£é™©ä½ |
| **1.0-2.0** | ğŸŸ¡ è¾ƒä¸ºæ˜¾è‘— - ç­–ç•¥è‰¯å¥½ï¼Œéœ€è°¨æ…éªŒè¯ |
| **0.0-1.0** | ğŸŸ  è½»å¾®æ˜¾è‘— - ç­–ç•¥ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆ |
| **< 0.0** | ğŸ”´ ä¸æ˜¾è‘— - ç­–ç•¥ä¸ä½³ï¼Œå¾ˆå¯èƒ½æ˜¯è¿‡æ‹Ÿåˆ |

**å…¬å¼ï¼š**
```
DSR = (SR_observed - E[max(SR_random)]) / Ïƒ(SR)
```

---

## ğŸ” æ•°æ®è¦æ±‚

### è¾“å…¥æ•°æ®æ ¼å¼

å›æµ‹å¼•æ“æœŸæœ›åŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š

```
ml_models/{SYMBOL}/predictions.parquet
```

**å¿…éœ€åˆ—ï¼š**
- `datetime` (ç´¢å¼•)
- `open`, `high`, `low`, `close`, `volume` - OHLCV æ•°æ®
- `y_pred_proba_long` - åšå¤šæ¦‚ç‡ (0-1)
- `y_pred_proba_short` - åšç©ºæ¦‚ç‡ (0-1)

**ç”Ÿæˆé¢„æµ‹æ•°æ®ï¼ˆä½¿ç”¨å·¥å• #009 è®­ç»ƒçš„æ¨¡å‹ï¼‰ï¼š**

```bash
# 1. è®­ç»ƒæ¨¡å‹
python bin/train_ml_model.py --symbol EURUSD --train

# 2. ç”Ÿæˆé¢„æµ‹
python bin/train_ml_model.py --symbol EURUSD --predict
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡è¯´æ˜

### æ ‡å‡†æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç›®æ ‡å€¼ |
|------|------|--------|
| **Sharpe Ratio** | (å¹´åŒ–æ”¶ç›Š - æ— é£é™©åˆ©ç‡) / å¹´åŒ–æ³¢åŠ¨ç‡ | > 1.0 |
| **Sortino Ratio** | (å¹´åŒ–æ”¶ç›Š - æ— é£é™©åˆ©ç‡) / ä¸‹è¡Œæ³¢åŠ¨ç‡ | > 1.5 |
| **Max Drawdown** | min(å‡€å€¼ / å†å²æœ€é«˜å‡€å€¼ - 1) | < -20% |
| **Calmar Ratio** | å¹´åŒ–æ”¶ç›Š / \|æœ€å¤§å›æ’¤\| | > 1.0 |
| **èƒœç‡** | ç›ˆåˆ©äº¤æ˜“æ•° / æ€»äº¤æ˜“æ•° | > 50% |

### Deflated Sharpe Ratio (DSR)

DSR ä¿®æ­£äº†ä»¥ä¸‹é—®é¢˜ï¼š
1. **å¤šé‡æµ‹è¯•åå·®** - ä½ æµ‹è¯•äº† 100 ç§ç­–ç•¥ï¼Œåªå±•ç¤ºæœ€å¥½çš„é‚£ä¸ª
2. **å›æµ‹è¿‡æ‹Ÿåˆ** - åå¤è°ƒå‚å¯¼è‡´"è™šå‡æ˜¾è‘—"
3. **æ”¶ç›Šç‡éæ­£æ€æ€§** - ååº¦ã€å³°åº¦å¯¼è‡´æ ‡å‡† SR å¤±çœŸ

**å…³é”®å‚æ•°ï¼š**
- `n_trials`: ç­–ç•¥è¯•éªŒæ¬¡æ•°ï¼ˆOptuna è°ƒå‚æ¬¡æ•° + æ‰‹åŠ¨è°ƒæ•´æ¬¡æ•°ï¼‰
- `n_observations`: æ ·æœ¬æ•°ï¼ˆäº¤æ˜“å¤©æ•°ï¼‰

---

## ğŸ›¡ï¸ é£é™©ç®¡ç†

### åŠ¨æ€ä»“ä½ç®¡ç†ï¼ˆKelly Criterionï¼‰

**å…¬å¼ï¼š**
```
Position_Size = (P_win - 0.5) / Volatility * Kelly_Fraction
```

**å˜é‡ï¼š**
- `P_win`: ML æ¨¡å‹é¢„æµ‹æ¦‚ç‡
- `Volatility`: ATR / Priceï¼ˆå½’ä¸€åŒ–æ³¢åŠ¨ç‡ï¼‰
- `Kelly_Fraction`: ä¿å®ˆç³»æ•°ï¼ˆé»˜è®¤ 0.25ï¼Œå››åˆ†ä¹‹ä¸€ Kellyï¼‰

**ç¤ºä¾‹ï¼š**
- é¢„æµ‹æ¦‚ç‡ = 0.70ï¼Œæ³¢åŠ¨ç‡ = 0.01 â†’ Position = 20% * 0.25 = 5%
- é¢„æµ‹æ¦‚ç‡ = 0.80ï¼Œæ³¢åŠ¨ç‡ = 0.02 â†’ Position = 15% * 0.25 = 3.75%

### æ­¢æŸä¸æ­¢ç›ˆ

**ATR åŠ¨æ€æ­¢æŸï¼š**
```python
stop_loss = entry_price - (ATR * 2.0)
take_profit = entry_price + (ATR * 2.0 * 2.0)  # æ­¢ç›ˆ/æ­¢æŸ = 2:1
```

**ç§»åŠ¨æ­¢æŸï¼š**
- å½“ä»·æ ¼å‘æœ‰åˆ©æ–¹å‘ç§»åŠ¨æ—¶ï¼Œæ­¢æŸä½è·Ÿéšç§»åŠ¨
- ç¡®ä¿"é”å®šåˆ©æ¶¦"

---

## âœ… éªŒæ”¶æµ‹è¯•æ¸…å•

### 1. çœŸå®æ€§éªŒè¯ âœ…

- [x] åŒ…å«åŒå‘äº¤æ˜“æˆæœ¬ï¼ˆç‚¹å·® + æ‰‹ç»­è´¹ï¼‰
- [x] æ¨¡æ‹Ÿæ»‘ç‚¹ï¼ˆ0.05%ï¼‰
- [x] äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆBacktraderï¼‰

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
python bin/run_backtest.py --symbol EURUSD --commission 0.0002 --spread 0.0002 --slippage 0.0005
```

### 2. åŸºå‡†å¯¹æ¯” âœ…

- [x] ç­–ç•¥ vs ä¹°å…¥æŒæœ‰
- [x] æ˜¾ç¤ºè¶…é¢æ”¶ç›Š

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
python bin/run_backtest.py --symbol EURUSD --benchmark
```

### 3. ç¨³å®šæ€§ï¼ˆWalk-Forwardï¼‰ âœ…

- [x] è®­ç»ƒé›†/æµ‹è¯•é›†åˆ†å‰²
- [x] å¤šçª—å£éªŒè¯
- [x] æ£€æµ‹è¿‡æ‹Ÿåˆï¼ˆè®­ç»ƒé›† vs æµ‹è¯•é›† Sharpe å·®å¼‚ï¼‰

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
python bin/run_backtest.py --symbol EURUSD --walk-forward
```

### 4. DSR è®¡ç®— âœ…

- [x] Deflated Sharpe Ratio
- [x] è€ƒè™‘å¤šé‡æµ‹è¯•
- [x] æ¦‚ç‡è°ƒæ•´

**æµ‹è¯•ä»£ç ï¼š**
```python
from src.reporting.tearsheet import calculate_deflated_sharpe_ratio

dsr_result = calculate_deflated_sharpe_ratio(
    observed_sr=1.5,
    n_trials=100,
    n_observations=252,
    skewness=-0.5,
    kurtosis=4.0
)
print(f"DSR: {dsr_result['dsr']:.3f}")
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: ç­–ç•¥æ”¶ç›Šä¸ºè´Ÿï¼Œæ˜¯å¦æ­£å¸¸ï¼Ÿ

**A:** æ­£å¸¸ï¼ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆéšæœºæ¦‚ç‡ï¼‰è¿›è¡Œå›æµ‹æ—¶ï¼Œç­–ç•¥æ”¶ç›Šå¯èƒ½ä¸ºè´Ÿã€‚è¿™è¯´æ˜ï¼š
1. âœ… äº¤æ˜“æˆæœ¬æ¨¡æ‹Ÿæ­£ç¡®ï¼ˆåƒæ‰äº†éšæœºç­–ç•¥çš„åˆ©æ¶¦ï¼‰
2. âœ… éœ€è¦ä½¿ç”¨çœŸå®çš„ ML æ¨¡å‹é¢„æµ‹æ•°æ®

**è§£å†³æ–¹æ³•ï¼š**
```bash
# ä½¿ç”¨å·¥å• #009 è®­ç»ƒçš„çœŸå®æ¨¡å‹
python bin/train_ml_model.py --symbol EURUSD --train
python bin/train_ml_model.py --symbol EURUSD --predict
python bin/run_backtest.py --symbol EURUSD  # å°†è‡ªåŠ¨åŠ è½½é¢„æµ‹æ•°æ®
```

### Q2: DSR ä¸ºè´Ÿï¼Œå¦‚ä½•æ”¹è¿›ï¼Ÿ

**A:** DSR ä¸ºè´Ÿé€šå¸¸æ„å‘³ç€ï¼š
1. ç­–ç•¥è¡¨ç°ä¸å¦‚"éšæœºè°ƒå‚"çš„æœŸæœ›å€¼
2. å¯èƒ½å­˜åœ¨ä¸¥é‡è¿‡æ‹Ÿåˆ

**æ”¹è¿›æ–¹æ³•ï¼š**
1. å‡å°‘è°ƒå‚æ¬¡æ•°ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰
2. å¢åŠ æ ·æœ¬æ•°ï¼ˆå»¶é•¿å›æµ‹å‘¨æœŸï¼‰
3. ä½¿ç”¨æ›´ç¨³å¥çš„ç‰¹å¾ï¼ˆå‡å°‘å™ªå£°ï¼‰
4. é™ä½ `n_trials` å‚æ•°ï¼ˆå¦‚æœä½ å®é™…ä¸Šåªè°ƒäº† 10 æ¬¡å‚æ•°ï¼Œä¸è¦è®¾ç½® 100ï¼‰

### Q3: Walk-Forward ç»“æœå·®å¼‚å¤§ï¼Ÿ

**A:** è®­ç»ƒé›†å’Œæµ‹è¯•é›† Sharpe Ratio å·®å¼‚ > 30% è¡¨æ˜è¿‡æ‹Ÿåˆã€‚

**è§£å†³æ–¹æ³•ï¼š**
1. å¢åŠ æ­£åˆ™åŒ–ï¼ˆL1/L2ï¼‰
2. å‡å°‘ç‰¹å¾æ•°é‡ï¼ˆç‰¹å¾é€‰æ‹©ï¼‰
3. ä½¿ç”¨æ›´é•¿çš„è®­ç»ƒçª—å£
4. é™ä½æ¨¡å‹å¤æ‚åº¦

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **Backtrader å®˜æ–¹æ–‡æ¡£**: https://www.backtrader.com/
2. **Kelly Criterion**: "A New Interpretation of Information Rate" (1956)
3. **Deflated Sharpe Ratio**: Bailey & LÃ³pez de Prado (2014)
4. **QuantStats**: https://github.com/ranaroussi/quantstats

---

## ğŸ“ æ¶æ„å¸ˆç¬”è®°

### ä¸ºä»€ä¹ˆä½¿ç”¨ Backtraderï¼Ÿ

> å…¶äº‹ä»¶é©±åŠ¨ (Event-Driven) æ¶æ„èƒ½ç²¾ç¡®æ¨¡æ‹Ÿ K çº¿å†…éƒ¨çš„è®¢å•æˆäº¤é¡ºåºï¼Œè¿™å¯¹ Triple Barrier ç­–ç•¥è‡³å…³é‡è¦ã€‚

**ä¸ Vectorized Backtesting å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | Backtrader (äº‹ä»¶é©±åŠ¨) | Vectorized (Pandas) |
|------|-----------------------|---------------------|
| **ç²¾åº¦** | ç²¾ç¡®æ¨¡æ‹Ÿè®¢å•ç°¿ | å¿½ç•¥ K çº¿å†…éƒ¨ç»†èŠ‚ |
| **æ­¢æŸæ­¢ç›ˆ** | æ”¯æŒ K çº¿å†…è§¦å‘ | åªèƒ½ç”¨æ”¶ç›˜ä»· |
| **é€Ÿåº¦** | è¾ƒæ…¢ | å¿« 10-100x |
| **é€‚ç”¨åœºæ™¯** | é«˜é¢‘ã€çŸ­çº¿ | ä½é¢‘ã€é•¿çº¿ |

### ä¸ºä»€ä¹ˆç”¨å››åˆ†ä¹‹ä¸€ Kellyï¼Ÿ

> å…¨ Kelly é£é™©å¤ªé«˜ï¼ˆ50% ä»“ä½æ³¢åŠ¨ï¼‰ï¼Œå››åˆ†ä¹‹ä¸€ Kelly åœ¨æ”¶ç›Šå’Œé£é™©ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

**å®è¯æ•°æ®ï¼ˆRalph Vinceï¼‰ï¼š**
- Full Kelly: æœ€å¤§å›æ’¤ -70%
- Half Kelly: æœ€å¤§å›æ’¤ -30%
- Quarter Kelly: æœ€å¤§å›æ’¤ -15% âœ… æ¨è

---

## ğŸ¯ ä¸‹ä¸€æ­¥

- [ ] å®ç›˜å¯¹æ¥ï¼ˆMT5 APIï¼‰
- [ ] å¤šå“ç§ç»„åˆå›æµ‹
- [ ] å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜ï¼ˆGrafanaï¼‰
- [ ] æ»‘ç‚¹æ¨¡å‹ä¼˜åŒ–ï¼ˆåŸºäºå†å² Tick æ•°æ®ï¼‰

---

**äº¤ä»˜æ—¥æœŸ**: 2025-12-20
**å·¥å•**: #010 - ç­–ç•¥å›æµ‹å¼•æ“ä¸é£é™©ç®¡ç†ç³»ç»Ÿ
**çŠ¶æ€**: âœ… å·²å®Œæˆ
