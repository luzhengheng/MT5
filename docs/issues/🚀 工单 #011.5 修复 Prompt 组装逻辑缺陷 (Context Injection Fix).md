🚀 工单 #011.5: 修复 Prompt 组装逻辑缺陷 (Context Injection Fix)  
优先级: P0 (最高 - 修复核心功能)  
类型: Bug Fix / Logic  
依赖: 工单 #011.4 (网络层已打通)  
目标: 修正 gemini_review_bridge.py 中构建提示词（Prompt）的循环逻辑。将原本“只读取硬编码白名单文件”的逻辑，改为“读取所有已动态捕获的文件”，确保 Git 检测到的变动代码（如 gemini_review_bridge.py 自身）能真正注入到发给 AI 的 Prompt 中。  
🔍 问题根因 (Root Cause Analysis)  
 * 数据获取层 (正常): get_code_context() 函数成功通过 get_changed_files() 获取到了变动文件（例如 gemini_review_bridge.py），并将其内容加载到了 code_context 字典中。  
 * 数据组装层 (故障): 在 generate_review_prompt 函数中，组装 Prompt 的代码逻辑是：  
   key_files = ["src/strategy/risk_manager.py", "nexus_with_proxy.py", ...]  
for file_path in key_files:  # <--- 罪魁祸首  
    if file_path in code_context:  
        # 写入内容...  
  
 * 结果: 即使 code_context 里有新文件，但只要它不在 key_files 这个死板的列表里，它就会被丢弃。导致 AI 收到的请求里只有项目概况，没有具体代码。  
🛠️ 实施任务清单  
1. 代码逻辑重构  
 * 文件: gemini_review_bridge.py  
 * 动作: 移除 generate_review_prompt 中的硬编码文件列表过滤逻辑。  
 * 新逻辑: 直接遍历 code_context 字典的所有条目。  
2. 验证修复  
 * 动作: 再次运行脚本。  
 * 预期: 生成的 Markdown 报告中，必须包含针对 gemini_review_bridge.py 代码修改的具体评价（证明 AI 看到了代码）。  
💻 代码变更规范 (Technical Spec)  
请指导 Claude 按以下差异（Diff）修改 gemini_review_bridge.py：  
    # ... 在 generate_review_prompt 方法内部 ...  
  
    prompt += f"""  
    ## 核心代码审查  
    """  
  
    # 🔴 删除旧逻辑 (Delete)  
    # key_files = [  
    #     "src/strategy/risk_manager.py",  
    #     "nexus_with_proxy.py",  
    #     "src/feature_engineering/"  
    # ]  
    #  
    # for file_path in key_files:  
    #     if file_path in code_context:  
    #         file_info = code_context[file_path]  
    #         ...  
  
    # 🟢 添加新逻辑 (Add)  
    # 直接遍历所有已获取的上下文文件  
    for file_path, file_info in code_context.items():  
        if file_info.get("type") == "file":  
            prompt += f"\n### 📄 {file_path}\n"  
            # 确保内容被包含  
            content = file_info.get('content', 'Unable to read file')  
            prompt += f"```python\n{content}...\n```\n"  
              
        elif file_info.get("type") == "directory":  
            prompt += f"\n### 📁 {file_path}\n"  
            files = file_info.get("files", [])  
            if files:  
                prompt += f"包含 {len(files)} 个文件: {', '.join(files[:10])}"  
                if len(files) > 10:  
                    prompt += f" 等 {len(files)} 个文件"  
  
🚀 执行指令 (发送给 Claude)  
请复制以下指令发送给 Claude Code：  
/read AI_RULES.md gemini_review_bridge.py  
请执行工单 #011.5：修复 Prompt 组装逻辑，解决“有请求但无代码”的 Bug。  
  
**背景**：目前脚本虽然能检测到文件变动，但在生成 Prompt 时，因为遍历的是一个硬编码的 `key_files` 列表，导致不在列表中的变动文件被过滤掉了。  
  
请按以下步骤修改 `gemini_review_bridge.py`：  
  
1.  **定位代码**：  
    - 找到 `generate_review_prompt` 函数。  
    - 找到 `## 核心代码审查` 下方的循环逻辑。  
  
2.  **重构循环**：  
    - **删除**：删除 `key_files = [...]` 列表定义和 `for file_path in key_files:` 循环。  
    - **替换**：改为直接遍历 `code_context` 字典：  
      ```python  
      for file_path, file_info in code_context.items():  
      ```  
    - **保留内部逻辑**：保留内部判断是 `file` 还是 `directory` 并拼接 Prompt 的逻辑。  
  
3.  **验证**：  
    - 运行 `python3 gemini_review_bridge.py`。  
    - 检查输出，确认本次生成的 Prompt 长度是否合理（应该包含代码内容）。  
  
4.  **提交**：  
    - 提交信息：`fix(logic): 修复 Prompt 组装逻辑，遍历所有动态获取的代码文件 #011.5`  
  
