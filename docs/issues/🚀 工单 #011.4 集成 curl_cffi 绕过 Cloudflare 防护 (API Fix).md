ğŸš€ å·¥å• #011.4: é›†æˆ curl_cffi ç»•è¿‡ Cloudflare é˜²æŠ¤ (API Fix)  
ä¼˜å…ˆçº§: P0 (æœ€é«˜ - é˜»æ–­æ€§æ•…éšœ)  
ç±»å‹: Bug Fix / Infrastructure  
ä¾èµ–: å·¥å• #011.3 (API è¿ç§»), Python åº“ curl_cffi  
ç›®æ ‡: å°† gemini_review_bridge.py çš„ HTTP å®¢æˆ·ç«¯ä»æ ‡å‡†çš„ requests åº“è¿ç§»è‡³ curl_cffiï¼Œå¯ç”¨æµè§ˆå™¨æŒ‡çº¹æ¨¡æ‹Ÿ (impersonate="chrome")ï¼Œä»¥é€šè¿‡ YYDS API çš„ Cloudflare WAF é˜²æŠ¤ï¼Œè§£å†³ 403 Forbidden é”™è¯¯ã€‚  
ğŸ“‹ é—®é¢˜æè¿°  
åœ¨å°è¯•è¿æ¥æ–°çš„ API ä¾›åº”å•† (api.yyds168.net) æ—¶ï¼Œè„šæœ¬é­é‡ 403 Forbidden é”™è¯¯ã€‚é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºè¯·æ±‚è¢« Cloudflare æ‹¦æˆªã€‚è¿™æ˜¯å› ä¸º Python æ ‡å‡† requests åº“çš„ TLS/SSL æŒ‡çº¹ç‰¹å¾è¢«è¯†åˆ«ä¸ºè‡ªåŠ¨åŒ–è„šæœ¬ã€‚  
ğŸ› ï¸ å®æ–½ä»»åŠ¡æ¸…å•  
1. ä¾èµ–ç®¡ç† (Dependency)  
 * åŠ¨ä½œ: å®‰è£… curl_cffi åº“ã€‚  
 * å‘½ä»¤: pip install curl_cffi  
 * åŒæ­¥: å°† curl_cffi>=0.7.0 æ·»åŠ åˆ° requirements.txtï¼Œç¡®ä¿ç¯å¢ƒå¯å¤ç°ã€‚  
2. ä»£ç é‡æ„ (Refactor)  
 * æ–‡ä»¶: gemini_review_bridge.py  
 * ä¿®æ”¹ç‚¹:  
   * æ›¿æ¢å¯¼å…¥: å°† import requests æ›¿æ¢ä¸º from curl_cffi import requestsã€‚  
   * æ·»åŠ ä¼ªè£…å‚æ•°: åœ¨ send_to_gemini å‡½æ•°çš„ requests.post è°ƒç”¨ä¸­ï¼Œæ–°å¢å‚æ•° impersonate="chrome120"ã€‚  
   * å¼ºåŒ– Headers: æ˜¾å¼è®¾ç½®ä¸€ä¸ªä¸ Chrome 120 åŒ¹é…çš„ User-Agentï¼Œé˜²æ­¢å¤´éƒ¨ç‰¹å¾ä¸ä¸€è‡´ã€‚  
3. éªŒè¯ä¸æµ‹è¯• (Verification)  
 * åŠ¨ä½œ: è¿è¡Œ python3 gemini_review_bridge.pyã€‚  
 * éªŒæ”¶æ ‡å‡†: API è¿”å› 200 OKï¼Œå¹¶æˆåŠŸç”Ÿæˆ Markdown å®¡æŸ¥æŠ¥å‘Šï¼Œä¸å†å‡ºç° 403 é”™è¯¯ã€‚  
ğŸ’» ä»£ç å˜æ›´è§„èŒƒ (Technical Spec)  
A. å¯¼å…¥éƒ¨åˆ†  
# æ—§ä»£ç   
# import requests  
  
# æ–°ä»£ç   
from curl_cffi import requests  # æ”¯æŒ TLS æŒ‡çº¹æ¨¡æ‹Ÿ  
  
B. è¯·æ±‚å‘é€é€»è¾‘ (send_to_gemini)  
def send_to_gemini(self, prompt, save_response=True):  
    # ... (å‰ç½®é€»è¾‘ä¸å˜) ...  
      
    # æ„é€ æ›´çœŸå®çš„ Headers  
    headers = {  
        "Authorization": f"Bearer {os.getenv('GEMINI_API_KEY')}",  
        "Content-Type": "application/json",  
        # å¿…é¡»ä¸ impersonate çš„ç‰ˆæœ¬åŒ¹é…  
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"  
    }  
  
    try:  
        print(f"ğŸ¤– å‘é€è¯·æ±‚åˆ° YYDS API (æ¨¡æ‹Ÿ Chrome æµè§ˆå™¨)...")  
          
        # ä½¿ç”¨ curl_cffi å‘é€è¯·æ±‚  
        response = requests.post(  
            url,  
            headers=headers,  
            json=payload,  
            timeout=120,  
            impersonate="chrome120"  # å…³é”®ä¿®å¤ï¼šæ¨¡æ‹Ÿ Chrome 120 çš„ TLS æŒ‡çº¹  
        )  
          
        # ... (åç»­å¤„ç†é€»è¾‘ä¸å˜) ...  
  
ğŸš€ æ‰§è¡ŒæŒ‡ä»¤ (å‘é€ç»™ Claude)  
è¯·å¤åˆ¶ä»¥ä¸‹æŒ‡ä»¤å‘é€ç»™ Claude Code (CLI) æˆ– Cursorï¼š  
/read AI_RULES.md gemini_review_bridge.py  
è¯·æ‰§è¡Œå·¥å• #011.4ï¼šè§£å†³ API è°ƒç”¨çš„ 403 Cloudflare æ‹¦æˆªé—®é¢˜ã€‚  
  
**èƒŒæ™¯**ï¼šå½“å‰çš„ `requests` åº“å› ä¸º TLS æŒ‡çº¹ç‰¹å¾è¢« API ä¾›åº”å•†çš„ Cloudflare é˜²ç«å¢™æ‹¦æˆª (403 Forbidden)ã€‚  
**æ–¹æ¡ˆ**ï¼šè¿ç§»è‡³ `curl_cffi` åº“ä»¥æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨ã€‚  
  
è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š  
  
1.  **å®‰è£…ä¾èµ–**ï¼š  
    - åœ¨ç»ˆç«¯æ‰§è¡Œ `pip install curl_cffi`ã€‚  
    - å°† `curl_cffi` æ·»åŠ åˆ° `requirements.txt` ä¸­ã€‚  
  
2.  **é‡æ„ä»£ç **ï¼š  
    - ç¼–è¾‘ `gemini_review_bridge.py`ã€‚  
    - å°†é¡¶éƒ¨çš„ `import requests` æ›¿æ¢ä¸º `from curl_cffi import requests`ã€‚  
    - å®šä½åˆ° `send_to_gemini` æ–¹æ³•ã€‚  
    - åœ¨æ„é€  `headers` æ—¶ï¼Œæ·»åŠ ä¸€ä¸ªçœŸå®çš„ Chrome User-Agentã€‚  
    - åœ¨ `requests.post()` è°ƒç”¨ä¸­ï¼Œæ·»åŠ å‚æ•° `impersonate="chrome120"`ã€‚  
  
3.  **éªŒè¯ä¿®å¤**ï¼š  
    - ä¿®æ”¹å®Œæˆåï¼Œè¯·å°è¯•è¿è¡Œ `python3 gemini_review_bridge.py`ï¼ˆå¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥å…ˆç”¨ print æ¨¡æ‹Ÿè¿è¡Œï¼Œæˆ–è€…çœŸå®è¿è¡Œä¸€æ¬¡çœ‹æ˜¯å¦æŠ¥é”™ï¼‰ã€‚  
    - ç¡®è®¤ä¸å†è¿”å› 403 é”™è¯¯ã€‚  
  
4.  **åŒæ­¥ä»£ç **ï¼š  
    - ä½¿ç”¨ DevOps è§„åˆ™æäº¤ï¼š`fix(infra): æ›¿æ¢ requests ä¸º curl_cffi ä»¥ç»•è¿‡ Cloudflare 403 æ‹¦æˆª #011.4`  
  
