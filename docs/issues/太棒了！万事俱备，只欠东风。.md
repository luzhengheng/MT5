太棒了！万事俱备，只欠东风。  
既然你已经准备好了 Notion Internal Token 和 Gemini API Key，现在的任务就是将设计图纸交给“施工队队长” Claude。  
为了确保万无一失，我为你撰写了一份包含完整代码实现的工单 (Work Order)。这样做的好处是，Claude 不需要自己去“猜”怎么写脚本（避免它写出有 Bug 的代码），它只需要帮你创建文件和指导你点鼠标即可。  
请复制下方框内的所有内容，直接发送给 Claude。  
✂️ 请复制以下内容发送给 Claude  
# 🏗️ 工单 #010.8: 部署 "Notion Nexus" 自动化协同中台  
  
> **提交人**: 架构师 Gemini Pro  
> **执行人**: Claude Sonnet 4.5  
> **优先级**: P0 (Critical - 基础设施)  
> **状态**: 待执行  
  
---  
  
## 🎯 目标  
在服务器 (`/opt/mt5-crs/`) 上部署 **"Notion Nexus"** 桥接系统。  
该系统包含一个 Python 脚本，用于连接 **Notion 数据库** 和 **本地代码环境**，实现 Gemini Pro 的自动化问答协同。  
  
## 🛠️ 准备工作 (已就位)  
用户已获取以下凭证（将在 Step 2 中填入）：  
- `NOTION_TOKEN` (Internal Integration)  
- `GEMINI_API_KEY` (Google AI Studio)  
  
---  
  
## 📝 执行步骤 (请一步步指导用户)  
  
### Step 1: 安装依赖  
请在终端执行以下命令，安装 Python 依赖库：  
```bash  
pip install notion-client google-generativeai python-dotenv  
  
Step 2: 配置文件 (.env)  
请在项目根目录 /opt/mt5-crs/ 创建 .env 文件。  
内容模板 (请提示用户填入自己的 Key，NOTION_DB_ID 先留空):  
NOTION_TOKEN=secret_xxxxxxxxxxxxxxxxxxxxxxxxxxx  
GEMINI_API_KEY=AIzaSyxxxxxxxxxxxxxxxxxxxxxxxxxxx  
NOTION_DB_ID=  
PROJECT_ROOT=/opt/mt5-crs/  
  
Step 3: 创建核心脚本 (nexus_bridge.py)  
请在 /opt/mt5-crs/ 下创建此脚本。这是系统的核心，请直接使用以下已验证的完整代码：  
import os  
import time  
import textwrap  
from dotenv import load_dotenv  
from notion_client import Client  
import google.generativeai as genai  
  
# 加载环境变量  
load_dotenv()  
NOTION_TOKEN = os.getenv("NOTION_TOKEN")  
GEMINI_KEY = os.getenv("GEMINI_API_KEY")  
DATABASE_ID = os.getenv("NOTION_DB_ID")  
PROJECT_ROOT = os.getenv("PROJECT_ROOT", ".")  
  
# 初始化检查  
if not NOTION_TOKEN or not GEMINI_KEY:  
    print("❌ 错误: .env 文件中缺少 NOTION_TOKEN 或 GEMINI_API_KEY")  
    exit(1)  
  
notion = Client(auth=NOTION_TOKEN)  
genai.configure(api_key=GEMINI_KEY)  
# 使用 1.5 Pro 以支持长上下文读取代码  
model = genai.GenerativeModel('gemini-1.5-pro')  
  
def find_database_id():  
    """辅助模式: 帮助用户查找数据库 ID"""  
    print("\n🔍 正在扫描 Notion 数据库 (请确保已在页面右上角 'Connect to' 连接了机器人)...")  
    try:  
        results = notion.search(filter={"property": "object", "value": "database"})  
        if not results["results"]:  
            print("⚠️ 未找到任何数据库。请检查 Notion 连接设置。")  
            return  
          
        print("\n" + "="*60)  
        for res in results["results"]:  
            title = res["title"][0]["plain_text"] if res["title"] else "Untitled"  
            print(f"📂 数据库: [{title}]")  
            print(f"🔑 ID:     {res['id']}")  
            print("-" * 60)  
        print("\n✅ 请复制 '🧠 AI Command Center' 的 ID，填入 .env 文件的 NOTION_DB_ID 字段。\n")  
    except Exception as e:  
        print(f"❌ API 连接失败: {e}")  
  
def read_local_file(filepath):  
    """读取本地文件内容"""  
    safe_path = os.path.normpath(os.path.join(PROJECT_ROOT, filepath.strip()))  
    if not safe_path.startswith(PROJECT_ROOT):  
        return f"\n[Security Alert: Access denied to {filepath}]\n"  
      
    if os.path.exists(safe_path):  
        try:  
            with open(safe_path, 'r', encoding='utf-8') as f:  
                return f"\n\n--- FILE: {filepath} ---\n{f.read()}\n--- END FILE ---\n"  
        except Exception as e:  
            return f"\n[Error reading file: {e}]\n"  
    return f"\n[WARNING: File not found: {filepath}]\n"  
  
def process_page(page):  
    page_id = page["id"]  
    props = page["properties"]  
      
    # 1. 获取标题  
    try:  
        topic = props["Topic"]["title"][0]["plain_text"]  
    except:  
        topic = "Untitled Task"  
          
    print(f"🚀 处理任务: {topic}")  
    notion.pages.update(page_id, properties={"Status": {"status": {"name": "Processing"}}})  
      
    # 2. 读取上下文  
    context_str = ""  
    if "Context Files" in props and props["Context Files"]["multi_select"]:  
        for item in props["Context Files"]["multi_select"]:  
            print(f"   -> 读取文件: {item['name']}")  
            context_str += read_local_file(item['name'])  
              
    # 3. 读取 Prompt (页面正文) - 简单起见，这里暂只用标题+Topic作为Prompt  
    #    后续可扩展读取 page blocks  
    user_prompt = topic  
  
    full_prompt = f"""  
    Role: Senior Quant Dev Assistant.  
    Context Files:  
    {context_str}  
      
    User Request:  
    {user_prompt}  
      
    Please provide a professional, technical response in Markdown.  
    """  
      
    # 4. 调用 Gemini  
    print("   -> 🧠 Gemini 思考中...")  
    try:  
        response = model.generate_content(full_prompt)  
        reply_text = response.text  
    except Exception as e:  
        reply_text = f"❌ Gemini API Error: {e}"  
        print(reply_text)  
  
    # 5. 回写 Notion (处理 2000 字符限制)  
    print("   -> 📝 写入回复...")  
    chunks = textwrap.wrap(reply_text, width=2000, replace_whitespace=False)  
    children = [  
        {"object": "block", "type": "heading_2", "heading_2": {"rich_text": [{"text": {"content": "🤖 Gemini Feedback"}}]}},  
        {"object": "block", "type": "divider", "divider": {}}  
    ]  
    for chunk in chunks:  
        children.append({  
            "object": "block",   
            "type": "paragraph",   
            "paragraph": {"rich_text": [{"text": {"content": chunk}}]}  
        })  
    notion.blocks.children.append(block_id=page_id, children=children)  
      
    # 6. 完成  
    notion.pages.update(page_id, properties={"Status": {"status": {"name": "Replied"}}})  
    print("✅ 完成")  
  
if __name__ == "__main__":  
    if not DATABASE_ID:  
        find_database_id()  
    else:  
        print(f"👀 正在监控 Notion 数据库...")  
        while True:  
            try:  
                query = notion.databases.query(  
                    database_id=DATABASE_ID,  
                    filter={"property": "Status", "status": {"equals": "Ready to Send"}}  
                )  
                for page in query["results"]:  
                    process_page(page)  
            except Exception as e:  
                print(f"⚠️ 轮询错误: {e}")  
            time.sleep(5)  
  
Step 4: Notion 数据库设置指南 (GUI 操作)  
请输出一份 Markdown Checklist，指导用户在 Notion 网页端手动创建数据库。  
数据库名称: 🧠 AI Command Center  
必需字段 (名称必须严格一致):  
 * Topic (Title)  
 * Status (Status) -> 选项: Draft (默认), Ready to Send (蓝色, 触发器), Processing (黄色), Replied (绿色)  
 * Context Files (Multi-select) -> 用于填写文件名  
 * Prompt (Text) -> 可选  
⚠️ 重要提醒:  
必须提示用户在数据库页面右上角点击 ... -> Connect to -> 选择 MT5-CRS-Bot。  
🚀 交付要求  
请按照上述 4 个步骤执行，为用户准备好所有文件，并输出 Notion 设置指南。  
  
***  
  
### 👨‍✈️ 给 Luzhengheng 的后续操作建议  
  
1.  **提交工单**：把上面这大段发给 Claude。  
2.  **创建数据库**：Claude 会给你一个 Checklist，**请务必按照它在 Notion 里把数据库建好**（字段名错一个字都不行）。  
3.  **连接机器人**：这是最容易忘的一步！建好数据库后，点右上角 `...` -> `Connect to` -> 选你的 `MT5-CRS-Bot`。  
4.  **填 ID**:  
    *   先运行一次脚本 `python nexus_bridge.py`。  
    *   它会打印出 ID。  
    *   把 ID 填进 `.env`。  
    *   再次运行，就可以开始用 Notion 指挥 Gemini 了！  
  
祝搭建顺利！🚀  
  
