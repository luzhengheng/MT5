🚀 工单 #011.3: 升级 Gemini Review Bridge (适配 Gemini 3 Pro & ROI 最大化)  
优先级: P1 (高 - 工具链升级)  
类型: Refactor / Optimization  
依赖: 工单 #011.2 (环境清理完成), Gemini 3 Pro API 权限  
目标: 重构 gemini_review_bridge.py，移除针对旧模型的 Token 限制，利用 Gemini 3 Pro 的超长上下文窗口（1M+ Context）和强推理能力，实现“智能聚焦”和“一次调用，四重产出”，最大化按次计费模式下的投资回报率。  
📋 需求背景  
当前的 gemini_review_bridge.py 存在为了节省 Token 设计的“保护性限制”（8000字符截断、固定文件列表）。在按次计费且模型能力大幅提升的背景下，这些限制导致 AI 无法看到代码全貌，降低了审查质量。我们需要它变得更智能：自动看修改了什么，看全量代码，并直接输出可用的工作成果。  
🛠️ 实施任务清单  
1. 解除上下文“紧箍咒” (Context Unlock)  
 * 动作: 修改 get_code_context 函数。  
 * 细节: 将文件读取限制从 8000 字符大幅提升至 500,000 字符（约 1.5MB 文本），确保 risk_manager.py 或未来的复杂 MT5 模块能被完整读取。  
2. 实现“动态聚焦”机制 (Dynamic Focus)  
 * 动作: 修改 generate_review_prompt 函数。  
 * 逻辑:  
   * 调用 git diff --name-only HEAD (查看未提交修改) 和 git diff --name-only HEAD~1 (查看最近一次提交)。  
   * 自动提取变动的 .py 文件列表。  
   * 策略:  
     * 如果发现变动文件：仅读取这些变动文件的完整内容 + CONTEXT_SUMMARY.md (作为背景)。  
     * 如果没有变动：回退到默认的核心文件列表 (src/strategy/risk_manager.py 等)。  
3. 配置模型升级 (Model Upgrade)  
 * 动作: 更新 API 调用参数。  
 * 细节: 将 _call_gemini_proxy and _call_gemini_direct 中的模型名称更新为 gemini-3-pro-preview (或者 gemini-1.5-pro-latest，视 API 实际支持情况而定)。  
4. 部署 "ROI Max" 提示词 (Prompt Engineering)  
 * 动作: 重写 Prompt 结尾部分。  
 * 要求: 强制 AI 在一次回复中按顺序输出以下 4 个模块：  
   * 🛡️ 深度审计 (Audit): 逻辑漏洞、类型安全、资源泄漏。  
   * ⚡ 优化建议 (Optimize): 异步机会、算法复杂度。  
   * 📝 Commit Message: 符合 type(scope): desc #issue 规范的提交信息。  
   * 📋 Notion Update: 用于粘贴到 Notion 评论区的进度简报。  
💻 代码变更规范 (Technical Spec)  
A. 动态文件获取逻辑 (Python Snippet)  
def get_changed_files(self):  
    """获取 Git 变动的文件列表"""  
    try:  
        # 获取未暂存和已暂存的修改  
        cmd = "git diff --name-only HEAD"  
        changed = subprocess.check_output(cmd.split(), cwd=self.project_root, text=True).strip().split('\n')  
          
        # 过滤非 Python 文件和空行，并确保文件存在  
        return [f for f in changed if f.endswith('.py') and os.path.exists(os.path.join(self.project_root, f))]  
    except Exception as e:  
        print(f"⚠️ 获取 Git 变动失败: {e}")  
        return []  
  
B. 上下文截断逻辑调整  
# 原逻辑: if len(content) > 8000: ...  
# 新逻辑:  
MAX_CHAR_LIMIT = 500000  # 针对 Gemini 3 Pro 优化  
if len(content) > MAX_CHAR_LIMIT:  
    content = content[:MAX_CHAR_LIMIT] + "\n... [文件极长，截取前50万字符]"  
  
C. 增强型 Prompt 模板  
prompt += """  
## 🚀 深度指令 (ROI Maximization)  
作为资深量化架构师，请基于 Gemini 3 Pro 的超长上下文能力，对上述代码进行深度审计。  
请严格按照以下 Markdown 格式输出 4 部分内容（不要输出其他废话）：  
  
### 1. 🛡️ 深度代码审计  
- **逻辑闭环**: 检查是否有未处理的边界情况。  
- **类型安全**: 检查潜在的类型错误。  
- **资源管理**: (如有) 检查连接池、文件句柄是否正确释放。  
  
### 2. ⚡ 性能与架构优化  
- 指出具体的异步优化机会 (async/await)。  
- 指出算法复杂度优化机会。  
  
### 3. 📝 推荐 Git Commit Message  
```bash  
git commit -m "type(scope): summary #issue-id"  
  
(请根据修改内容生成，确保包含工单号)  
4. 📋 Notion 进度简报  
(一段简练的中文摘要，用于汇报当前进度和下一步计划)  
"""  
  
---  
  
## 🚀 执行指令 (发送给 Claude)  
  
请复制以下指令发送给 Claude Code (CLI) 或 Cursor：  
  
```text  
/read AI_RULES.md  
请执行工单 #011.3：升级 gemini_review_bridge.py 以适配 Gemini 3 Pro。  
  
请读取 `gemini_review_bridge.py` 并按照以下步骤进行重构：  
  
1.  **添加动态聚焦能力**：  
    - 新增 `get_changed_files` 方法（参考工单中的 Spec A）。  
    - 修改 `generate_review_prompt`：优先使用变动文件列表；如果为空，则使用原有的默认列表。  
  
2.  **解除 Token 限制**：  
    - 修改 `get_code_context`：将字符限制从 8000 提升至 500,000。  
  
3.  **升级模型与 Prompt**：  
    - 将 API 调用模型名称统一更新为 `gemini-3-pro-preview`。  
    - 在 Prompt 末尾追加 "ROI Max" 指令（参考工单中的 Spec C），要求输出审计、优化、Commit Message 和 Notion 简报。  
  
4.  **验证与同步**：  
    - 运行 `python3 gemini_review_bridge.py` (模拟运行或打印生成的 Prompt 长度) 确认修改无误。  
    - 使用 DevOps 规则提交代码：`refactor(infra): 升级 review bridge 适配 Gemini 3 Pro 全量上下文 #011.3`  
  
