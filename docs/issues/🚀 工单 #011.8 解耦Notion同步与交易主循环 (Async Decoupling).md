ğŸš€ å·¥å• #011.8: è§£è€¦ Notion åŒæ­¥ä¸äº¤æ˜“ä¸»å¾ªç¯ (Async Decoupling)

ä¼˜å…ˆçº§: P0 (æœ€é«˜ - ç›´æ¥å½±å“å®ç›˜äº¤æ˜“æ€§èƒ½)
ç±»å‹: Critical Infrastructure / Performance
ä¾èµ–: å·¥å• #011.7 (è·¯å¾„ä¿®å¤)
ç›®æ ‡: é‡æ„ Notion åŒæ­¥é€»è¾‘ï¼Œä»åŒæ­¥é˜»å¡æ–¹å¼æ”¹ä¸ºå¼‚æ­¥éé˜»å¡æ–¹å¼ã€‚ç¡®ä¿ Notion API è°ƒç”¨ï¼ˆé€šå¸¸ 200ms-1s å»¶è¿Ÿï¼‰ä¸ä¼šé˜»å¡äº¤æ˜“ä¸»çº¿ç¨‹ï¼Œé˜²æ­¢é”™è¿‡è¡Œæƒ… (Tick Loss)ã€‚

## ğŸ” é—®é¢˜æ ¹å›  (Root Cause Analysis)

**å‘ç°è€…**: Gemini Pro ä»£ç å®¡æŸ¥ (2025-12-22)

**å½“å‰ç“¶é¢ˆ**:
1. `create_notion_issue.py` å’Œ `update_notion_from_git.py` ä½¿ç”¨ `requests` åŒæ­¥åº“
2. è‹¥è¿™äº›è„šæœ¬è¢«äº¤æ˜“ç­–ç•¥ç›´æ¥è°ƒç”¨ï¼ˆä¾‹å¦‚æ¯ç¬”äº¤æ˜“åæ›´æ–°æ—¥å¿—ï¼‰ï¼Œç½‘ç»œå»¶è¿Ÿï¼ˆé€šå¸¸ 200ms-1sï¼‰ä¼šé˜»å¡ä¸»çº¿ç¨‹
3. Git Hooks ä¸­çš„ `pre-commit` è°ƒç”¨ Python è„šæœ¬è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œå¯¼è‡´æ¯æ¬¡ commit å¡é¡¿æ•°ç§’
4. å¤šä¸ªè„šæœ¬é‡å¤åˆå§‹åŒ– Notion Headersï¼Œæµªè´¹ SSL æ¡æ‰‹å¼€é”€

**åæœ**:
- å®ç›˜äº¤æ˜“ä¸­å¯èƒ½é”™è¿‡å…³é”® Ticks
- å¼€å‘ä½“éªŒå·®ï¼ˆæäº¤æ—¶å¡é¡¿ï¼‰
- èµ„æºæµªè´¹ï¼ˆå¤šæ¬¡ SSL æ¡æ‰‹ï¼‰
- è¿å "äº¤æ˜“æ ¸å¿ƒä¸åº”ä¾èµ–å¤–éƒ¨ API" çš„åŸåˆ™

## ğŸ› ï¸ å®æ–½ä»»åŠ¡æ¸…å•

### 1. åˆ›å»ºå¼‚æ­¥ Notion å®¢æˆ·ç«¯ (NotionClient)

**æ–‡ä»¶**: `src/infrastructure/notion_client_async.py`

**åŠŸèƒ½**:
- ä½¿ç”¨ `aiohttp` æˆ– `httpx` åº“å®ç°å¼‚æ­¥ HTTP è°ƒç”¨
- å•ä¾‹æ¨¡å¼ï¼Œè¿æ¥æ± å¤ç”¨ï¼Œå‡å°‘ SSL æ¡æ‰‹
- æä¾›å¼‚æ­¥æ–¹æ³•: `async_create_issue()`, `async_update_issue()` ç­‰
- çº¿ç¨‹å®‰å…¨ï¼ˆå¦‚æœåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰

**å…³é”®è®¾è®¡**:
```python
import aiohttp
import asyncio
from typing import Dict, Any

class NotionClientAsync:
    """å¼‚æ­¥ Notion API å®¢æˆ·ç«¯ - å•ä¾‹æ¨¡å¼"""

    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._initialized = False
        return cls._instance

    def __init__(self):
        if self._initialized:
            return

        self.token = os.getenv("NOTION_TOKEN")
        self.base_url = "https://api.notion.com/v1"
        self.headers = {
            "Authorization": f"Bearer {self.token}",
            "Content-Type": "application/json",
            "Notion-Version": "2024-06-15"
        }
        self._session = None
        self._initialized = True

    async def _get_session(self) -> aiohttp.ClientSession:
        """è·å–æˆ–åˆ›å»º HTTP è¿æ¥"""
        if self._session is None:
            self._session = aiohttp.ClientSession()
        return self._session

    async def async_create_issue(self, database_id: str, title: str) -> Dict[str, Any]:
        """å¼‚æ­¥åˆ›å»º Notion issue"""
        session = await self._get_session()
        url = f"{self.base_url}/pages"
        # ... å®ç°å¼‚æ­¥è¯·æ±‚

    async def close(self):
        """å…³é—­è¿æ¥"""
        if self._session:
            await self._session.close()
```

### 2. åˆ›å»ºä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ (Background Queue)

**æ–‡ä»¶**: `src/infrastructure/background_queue.py`

**åŠŸèƒ½**:
- ä½¿ç”¨ `asyncio.Queue` æˆ– `Redis Queue` ç¼“å­˜ Notion æ›´æ–°ä»»åŠ¡
- åå°å·¥ä½œçº¿ç¨‹å¼‚æ­¥å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- æä¾›éé˜»å¡çš„ `enqueue()` æ–¹æ³•ä¾›äº¤æ˜“æ ¸å¿ƒè°ƒç”¨

**å…³é”®è®¾è®¡**:
```python
import asyncio
from asyncio import Queue

class NotionBackgroundQueue:
    """Notion æ“ä½œåå°é˜Ÿåˆ— - ä¸äº¤æ˜“å¾ªç¯è§£è€¦"""

    def __init__(self, max_queue_size: int = 1000):
        self.queue = Queue(maxsize=max_queue_size)
        self.running = False

    def enqueue(self, task: Dict[str, Any]) -> bool:
        """
        éé˜»å¡åœ°å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
        ç”¨äºäº¤æ˜“ç­–ç•¥è°ƒç”¨ - æå¿«è¿”å› (< 1ms)
        """
        try:
            self.queue.put_nowait(task)
            return True
        except asyncio.QueueFull:
            logger.warning("Notion queue full, task dropped")
            return False

    async def start(self):
        """å¯åŠ¨åå°ä»»åŠ¡å¤„ç†"""
        self.running = True
        while self.running:
            try:
                task = await asyncio.wait_for(self.queue.get(), timeout=1.0)
                await self._process_task(task)
            except asyncio.TimeoutError:
                continue

    async def _process_task(self, task: Dict[str, Any]):
        """å¤„ç†å•ä¸ªä»»åŠ¡"""
        client = NotionClientAsync()
        # å¼‚æ­¥è°ƒç”¨ Notion API
        # ...
```

### 3. é‡æ„ Git Hooks

#### 3.1 `pre-commit` Hook
- **æ”¹è¿›**: ä»…è¿›è¡Œæœ¬åœ°å¿«é€Ÿæ£€æŸ¥ï¼ˆLintingã€ç±»å‹æ£€æŸ¥ï¼‰
- **åˆ é™¤**: æ‰€æœ‰ç½‘ç»œè¯·æ±‚ï¼ˆNotion æ£€æŸ¥ï¼‰
- **æ–‡ä»¶**: `.git/hooks/pre-commit`

```bash
#!/bin/bash
# å¿«é€Ÿæœ¬åœ°æ£€æŸ¥ - æ— ç½‘ç»œä¾èµ–

# 1. ä»£ç é£æ ¼æ£€æŸ¥
flake8 src/ scripts/

# 2. ç±»å‹æ£€æŸ¥
mypy src/

# å¦‚æœæœ‰é”™è¯¯ï¼Œæ‹’ç»æäº¤
if [ $? -ne 0 ]; then
    exit 1
fi

exit 0
```

#### 3.2 `post-commit` Hook
- **æ”¹è¿›**: æ”¹ä¸ºå¼‚æ­¥æ‰§è¡Œï¼ˆä½¿ç”¨ `&` æ”¾å…¥åå°ï¼‰
- **åŠŸèƒ½**: è°ƒç”¨å¼‚æ­¥ Notion æ›´æ–°ï¼Œä¸é˜»å¡æäº¤æµç¨‹
- **æ–‡ä»¶**: `.git/hooks/post-commit`

```bash
#!/bin/bash
# åå°å¼‚æ­¥ Notion åŒæ­¥ - ä¸é˜»å¡ç”¨æˆ·

python3 /path/to/sync_notion_async.py > /tmp/notion_sync.log 2>&1 &
exit 0  # ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…åå°ä»»åŠ¡
```

### 4. åˆ›å»ºå¼‚æ­¥åŒæ­¥è„šæœ¬

**æ–‡ä»¶**: `src/infrastructure/sync_notion_async.py`

**åŠŸèƒ½**:
- æ›¿ä»£å½“å‰çš„ `sync_notion_improved.py`
- ä½¿ç”¨ `async def` å’Œ `await`
- æ”¯æŒå¹¶å‘å¤„ç†å¤šä¸ª issue æ›´æ–°

### 5. ä¿®æ”¹äº¤æ˜“ç­–ç•¥è°ƒç”¨æ–¹å¼

**åŸæ¥çš„æ–¹å¼** (åŒæ­¥ã€é˜»å¡):
```python
# åœ¨äº¤æ˜“å¾ªç¯ä¸­ - è¿™ä¼šå¯¼è‡´å»¶è¿Ÿï¼
from scripts.create_notion_issue import create_issue
create_issue(order_info)  # é˜»å¡ 200ms-1s
next_tick()  # å»¶è¿Ÿ
```

**æ–°çš„æ–¹å¼** (å¼‚æ­¥ã€éé˜»å¡):
```python
# åœ¨äº¤æ˜“å¾ªç¯ä¸­ - æå¿«è¿”å›
from src.infrastructure.background_queue import notion_queue
notion_queue.enqueue({
    "action": "create_issue",
    "data": order_info
})  # è¿”å› < 1ms
next_tick()  # ç»§ç»­
```

## ğŸ’» ä»£ç å˜æ›´è§„èŒƒ (Technical Spec)

### ä¾èµ–æ›´æ–°
```bash
# æ›´æ–° requirements.txt
aiohttp>=3.8.0
httpx>=0.24.0  # å¯é€‰ï¼Œæ›´ç°ä»£çš„å¼‚æ­¥ HTTP åº“
```

### ä¿®æ”¹ `gemini_review_bridge.py`
- æ”¹ç”¨å¼‚æ­¥ Notion å®¢æˆ·ç«¯
- åå°æäº¤å®¡æŸ¥ç»“æœï¼Œä¸é˜»å¡å®¡æŸ¥æµç¨‹

### ä¿®æ”¹ `sync_notion_improved.py`
- æ”¹ä¸ºå¼‚æ­¥å®ç°
- æ–‡ä»¶å: æ”¹ä¸º `sync_notion_async.py`

## ğŸš€ æ‰§è¡ŒæŒ‡ä»¤

1. **åˆ›å»ºå¼‚æ­¥å®¢æˆ·ç«¯**:
   ```bash
   touch src/infrastructure/notion_client_async.py
   # å¤åˆ¶ä¸Šè¿°ä»£ç 
   ```

2. **åˆ›å»ºèƒŒæ™¯é˜Ÿåˆ—**:
   ```bash
   touch src/infrastructure/background_queue.py
   # å¤åˆ¶ä¸Šè¿°ä»£ç 
   ```

3. **é‡æ„ Git Hooks**:
   ```bash
   # æ›´æ–° pre-commit å’Œ post-commit
   ```

4. **æ›´æ–°ä¾èµ–**:
   ```bash
   pip install aiohttp
   ```

5. **æµ‹è¯•**:
   ```bash
   # å•å…ƒæµ‹è¯•å¼‚æ­¥å®¢æˆ·ç«¯
   pytest tests/test_notion_client_async.py

   # é›†æˆæµ‹è¯•æ•´ä¸ªæµç¨‹
   python3 tests/test_async_integration.py
   ```

6. **æäº¤**:
   ```bash
   git commit -m "refactor(async): è§£è€¦NotionåŒæ­¥ä¸äº¤æ˜“ä¸»å¾ªç¯ï¼Œå®ç°å¼‚æ­¥éé˜»å¡æ¶æ„ #011.8"
   ```

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

- âœ… Notion æ“ä½œä¸å†é˜»å¡äº¤æ˜“ä¸»å¾ªç¯
- âœ… æ¯æ¬¡å¼‚æ­¥æ“ä½œè¿”å› < 1ms
- âœ… Git æäº¤ä¸å†å¡é¡¿ï¼ˆpre-commit æœ¬åœ°åŒ–ï¼‰
- âœ… èµ„æºå¤ç”¨ï¼šHTTP è¿æ¥æ± ï¼Œå‡å°‘ SSL æ¡æ‰‹
- âœ… æ€§èƒ½æ”¹å–„å¯æµ‹é‡ï¼šæ¯”å¯¹å‰åçš„ååé‡ï¼ˆorders/secï¼‰

## ğŸ”— å…³è”

- ä¾èµ–: å·¥å• #011.7 (è·¯å¾„ä¿®å¤)
- å‰ç½®: æ— 
- åç»§: å·¥å• #011.9 (æ ¸å¿ƒ MT5 ä»£ç )

