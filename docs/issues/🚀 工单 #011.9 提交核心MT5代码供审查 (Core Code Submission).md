🚀 工单 #011.9: 提交核心 MT5 代码供审查 (Core Code Submission)

优先级: P1 (高 - 无法验证实盘逻辑)
类型: Code Review / Critical Path
依赖: 工单 #011.8 (异步解耦)
目标: 提交 MT5 桥接核心代码和交易策略核心代码到 Gemini Pro 进行深度审查。当前审查仅涵盖 DevOps/MLOps 基础设施，缺失实盘交易逻辑的验证。

## 🔍 问题根因 (Root Cause Analysis)

**发现者**: Gemini Pro 代码审查 (2025-12-22)

**当前状态**:
- 工单 #011 标题：实盘交易系统对接
- 当前提交的代码：全为辅助脚本（Notion 同步、Git Hooks、Gemini 诊断）
- **缺失的代码**：MT5 API 桥接、Kelly 公式实现、交易订单执行逻辑

**间接证据**:
- `gemini_review_demo.py` 中明确指出两个 **P0 级缺陷**：
  1. `KellySizer` 中的单位转换缺失（可能导致杠杆计算错误）
  2. `nexus_with_proxy.py` 的网络同步阻塞风险（可能导致交易延迟）
- 这表明核心代码存在已知问题，但未在此次审查中进行详细检查

**后果**:
- 无法验证实盘交易逻辑的安全性和正确性
- Kelly 公式实现可能存在 Bug，导致杠杆设置错误
- MT5 连接稳定性、订单执行流程无法评估
- 无法进行压力测试和风险评估

## 📋 需要审查的核心代码 (7 个模块)

### 1. MT5 API 桥接 (High Priority)
**文件**: `src/mt5_bridge/` (如果存在) 或相关 MT5 连接代码
**内容**:
- MT5 API 初始化和连接管理
- 行情数据获取
- 订单执行和管理
- 账户信息查询

**当前状态**: ⚠️ 可能尚未开发或未提交

### 2. Kelly 公式实现 (Critical - Known Bug)
**文件**: `src/strategy/risk_manager.py` (已存在)
**已知问题** (来自 Gemini 上次审查):
- 单位转换缺失：交易对可能有不同的点值 (Point Value)
- 示例：EUR/USD 每点 $10，但某些商品点值不同
- 当前 Kelly 计算可能未考虑这一点

**审查目标**:
- 验证单位转换逻辑
- 检查点值参数化处理
- 确保杠杆计算准确（风险评估）

### 3. 特征工程 (Medium Priority)
**文件**:
- `src/feature_engineering/basic_features.py`
- `src/feature_engineering/advanced_features.py`

**审查目标**:
- 实时计算性能（交易延迟影响）
- 特征缺失值处理
- 特征的因果关系验证（避免前视偏差 Look-ahead Bias）

### 4. 标签和样本准备 (Medium Priority)
**文件**: `src/feature_engineering/labeling.py`

**审查目标**:
- 三重障碍法的参数设置（阈值是否合理）
- 样本不平衡处理
- 标签泄露风险评估

### 5. ML 模型和预测 (Medium Priority)
**文件**: `src/models/` (如果存在)

**审查目标**:
- 过拟合风险评估
- 模型选择的合理性（为何选择这个模型）
- 交易信号的可靠性

### 6. 回测系统 (Medium Priority)
**文件**: `bin/run_backtest.py`, `src/reporting/tearsheet.py`

**审查目标**:
- 回测的真实性（滑点、手续费、执行延迟是否考虑）
- 样本容量是否足够（统计显著性）
- 参数优化的过拟合风险

### 7. 订单执行和风险管理 (High Priority)
**文件**: `src/strategy/ml_strategy.py` (如果存在) 或主策略文件

**审查目标**:
- 订单下单逻辑（何时下单、手数计算）
- 止损和止盈的设置（动态还是固定）
- 滑点和手续费的实际影响
- 大于等于风险的情况下是否跳过交易

## 🛠️ 实施任务清单

### 1. 代码清理和组织

**动作**:
- 确保所有核心代码文件都在适当的目录中
- 移除调试代码、注释掉的代码、测试代码
- 添加必要的文档字符串 (Docstrings)

**检查清单**:
```bash
# 检查核心文件是否存在
[ -f src/mt5_bridge/mt5_api.py ] && echo "✅ MT5 API" || echo "❌ MT5 API 缺失"
[ -f src/strategy/risk_manager.py ] && echo "✅ Kelly 实现" || echo "❌ Kelly 缺失"
[ -f src/feature_engineering/basic_features.py ] && echo "✅ 基础特征" || echo "❌ 基础特征缺失"
[ -f src/strategy/ml_strategy.py ] && echo "✅ 策略逻辑" || echo "❌ 策略缺失"
```

### 2. 添加代码审查信息

**文件**: 创建 `docs/CORE_CODE_REVIEW_GUIDE.md`

**内容**:
```markdown
# 核心代码审查指南

## 关键问题

### 1. Kelly 公式
- **现状**: risk_manager.py 中的 Kelly 公式
- **已知 Bug**: 单位转换缺失
- **需要检查**:
  - [ ] Point Value 是否参数化
  - [ ] 单位转换公式是否正确
  - [ ] 是否处理了不同交易对的差异

### 2. MT5 连接
- **现状**: MT5 API 连接状态
- **需要检查**:
  - [ ] 连接失败时的重试机制
  - [ ] 心跳检测是否实现
  - [ ] 网络异常时是否有降级策略

### 3. 订单执行
- **现状**: 订单下单逻辑
- **需要检查**:
  - [ ] 滑点是否考虑
  - [ ] 手续费是否计入风险管理
  - [ ] 大于等于风险的订单是否被拒绝

### 4. 特征计算
- **现状**: 实时特征计算
- **需要检查**:
  - [ ] 计算延迟是否会导致交易延迟
  - [ ] 特征是否有前视偏差
  - [ ] 缺失值如何处理

## 期望输出

Gemini Pro 应提供：
1. 详细的代码审查报告（每个模块 50-100 行评论）
2. P0/P1/P2 级别的 Bug 列表
3. 架构改进建议
4. 性能优化方案
5. 压力测试建议
```

### 3. 生成完整的代码上下文包

**动作**:
- 运行 `python3 export_context_for_ai.py` 生成新的上下文包
- 确保包含所有核心文件 (特别是 `src/strategy/`, `src/mt5_bridge/`)

### 4. 创建审查请求文件

**文件**: `docs/GEMINI_CORE_CODE_REVIEW_REQUEST.md`

**内容**:
```markdown
# Gemini Pro 核心代码审查请求

## 背景
工单 #011 - 实盘交易系统对接
当前进度：DevOps/MLOps 基础设施已审查和改进
现在需要：核心交易逻辑的深度审查

## 上下文文件
见 exports/core_files_*.md

## 重点审查方向

### 1. Kelly 公式 (Critical Bug)
- Risk Manager 中的 Kelly 计算
- **已知问题**: 单位转换缺失
- **需要**: 完整的代码审查和修复方案

### 2. MT5 连接 (Stability)
- 连接管理和重试机制
- 网络异常处理
- 心跳检测

### 3. 订单执行 (Correctness)
- 滑点和手续费的处理
- 风险控制逻辑
- 边界情况处理

### 4. 特征工程 (Timeliness)
- 实时计算性能
- 前视偏差检查
- 缺失值处理

## 期望输出格式
参见 docs/CORE_CODE_REVIEW_GUIDE.md
```

### 5. 准备审查提交

**动作**:
1. 执行代码清理 (移除调试代码、冗余文件)
2. 运行自动化检查 (Linting、类型检查)
3. 生成完整的上下文包
4. 准备审查请求文档

## 💻 代码变更规范 (Technical Spec)

### 核心文件清单 (应提交给 Gemini)

```
src/mt5_bridge/
├── mt5_api.py          # MT5 API 封装
├── connection.py       # 连接管理
└── ...

src/strategy/
├── ml_strategy.py      # 主策略逻辑
├── risk_manager.py     # Kelly 公式 ⚠️ 有 Bug
├── order_executor.py   # 订单执行
└── ...

src/feature_engineering/
├── basic_features.py
├── advanced_features.py
└── labeling.py

src/models/
├── trainer.py          # 模型训练
├── evaluator.py        # 模型评估
└── ...

bin/
├── run_backtest.py     # 回测系统
└── train_ml_model.py   # 训练脚本

src/reporting/
├── tearsheet.py        # 回测报告
└── ...
```

## 🚀 执行指令

1. **代码清理**:
   ```bash
   # 移除调试代码、注释掉的代码
   find src/ -name "*.py" -exec grep -l "# TODO\|# HACK\|print(" {} \;
   ```

2. **自动检查**:
   ```bash
   # Linting
   flake8 src/ --max-line-length=100

   # 类型检查
   mypy src/
   ```

3. **生成上下文包**:
   ```bash
   python3 export_context_for_ai.py
   ```

4. **准备审查文档**:
   ```bash
   # 创建审查指南
   touch docs/CORE_CODE_REVIEW_GUIDE.md
   touch docs/GEMINI_CORE_CODE_REVIEW_REQUEST.md
   ```

5. **提交**:
   ```bash
   git add src/ docs/CORE_CODE_REVIEW_GUIDE.md docs/GEMINI_CORE_CODE_REVIEW_REQUEST.md
   git commit -m "docs(review): 准备核心代码供 Gemini Pro 审查 - Kelly 公式和 MT5 连接 #011.9"
   ```

6. **发送给 Gemini Pro**:
   ```bash
   # 复制以下内容到 Gemini Pro:
   # 1. docs/CORE_CODE_REVIEW_GUIDE.md
   # 2. docs/GEMINI_CORE_CODE_REVIEW_REQUEST.md
   # 3. exports/core_files_*.md (最新的上下文包)
   ```

## 📊 成功指标

- ✅ 所有 7 个核心模块都已提交供审查
- ✅ Gemini Pro 确认收到并开始审查
- ✅ 获得 P0/P1 级 Bug 列表
- ✅ 收到 Kelly 公式的修复建议
- ✅ 收到 MT5 连接的稳定性评估
- ✅ 收到性能优化建议

## 🔗 关联

- 依赖: 工单 #011.8 (异步解耦 - 可并行开展)
- 前置: 代码清理完成
- 后继: 工单 #012 (根据 Gemini 反馈修复 Bug)

## 📅 预期时间线

- 提交审查：2025-12-23
- Gemini Pro 审查时间：2-4 小时（深度审查）
- 获得反馈：2025-12-23 或 2025-12-24
- 修复实施：根据反馈的优先级分阶段

