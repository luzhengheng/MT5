# Notion-Git è‡ªåŠ¨åŒæ­¥é—®é¢˜ä¿®å¤æŒ‡å—

## ðŸ“‹ é—®é¢˜è¯Šæ–­

### åŒæ­¥å¤±è´¥çš„æ ¹æœ¬åŽŸå› 

2025-12-22 å‘çŽ° Git-Notion è‡ªåŠ¨åŒæ­¥å¤±è´¥ï¼Œå·¥å•çŠ¶æ€æ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚

#### é—®é¢˜ 1: å±žæ€§åä¸åŒ¹é… âŒ

**æ–‡ä»¶**: `update_notion_from_git.py:160`

```python
# âŒ é”™è¯¯ä»£ç 
"Status": {  # ä½¿ç”¨è‹±æ–‡å±žæ€§å
    "status": {"name": new_status}
}

# âœ… æ­£ç¡®ä»£ç 
"çŠ¶æ€": {  # ä½¿ç”¨ä¸­æ–‡å±žæ€§å
    "status": {"name": new_status}
}
```

**æ ¹æœ¬åŽŸå› **: Notion Issues æ•°æ®åº“ä½¿ç”¨ä¸­æ–‡å±žæ€§åï¼Œè„šæœ¬å´ä½¿ç”¨è‹±æ–‡å±žæ€§åã€‚

#### é—®é¢˜ 2: æŸ¥è¯¢å±žæ€§é”™è¯¯ âŒ

**æ–‡ä»¶**: `update_notion_from_git.py:138-140`

```python
# âŒ é”™è¯¯ä»£ç 
query_data = {
    "filter": {
        "property": "ID",      # å±žæ€§ä¸å­˜åœ¨
        "rich_text": {         # è¿‡æ»¤å™¨ç±»åž‹é”™è¯¯
            "equals": f"#{issue_id}"
        }
    }
}

# âœ… æ­£ç¡®ä»£ç 
query_data = {
    "filter": {
        "property": "åç§°",     # ä½¿ç”¨æ­£ç¡®çš„å±žæ€§å
        "title": {              # ä½¿ç”¨æ­£ç¡®çš„è¿‡æ»¤å™¨ç±»åž‹
            "contains": f"#{issue_id}"
        }
    }
}
```

**æ ¹æœ¬åŽŸå› **:
- Notion Issues æ•°æ®åº“æ²¡æœ‰ "ID" å±žæ€§
- å±žæ€§ "åç§°" æ˜¯ title ç±»åž‹ï¼Œéœ€è¦ç”¨ title è¿‡æ»¤å™¨ï¼Œä¸èƒ½ç”¨ rich_text

#### é—®é¢˜ 3: æ•°æ®åº“ Schema ä¸åŒ¹é… âŒ

**å®žé™… Notion Issues æ•°æ®åº“**:
- âœ… `åç§°` (title) - å·¥å•æ ‡é¢˜
- âœ… `çŠ¶æ€` (status) - å·¥å•çŠ¶æ€
- âœ… `æ—¥æœŸ` (date) - å·¥å•æ—¥æœŸ

**è„šæœ¬æœŸæœ›çš„å±žæ€§**ï¼ˆé”™è¯¯ï¼‰:
- âŒ `ID` (rich_text) - ä¸å­˜åœ¨
- âŒ `Status` (status) - å±žæ€§åé”™è¯¯
- âŒ `Code Delta` (number) - ä¸å­˜åœ¨

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä½¿ç”¨æ”¹è¿›çš„è„šæœ¬ (æŽ¨è) ðŸŽ¯

æ–°è„šæœ¬ `sync_notion_improved.py` å·²å®Œå…¨é‡å†™ï¼Œè§£å†³äº†æ‰€æœ‰å…¼å®¹æ€§é—®é¢˜ã€‚

**ç‰¹ç‚¹**:
- âœ… æ­£ç¡®çš„å±žæ€§åæ˜ å°„ï¼ˆä¸­æ–‡å±žæ€§åï¼‰
- âœ… æ­£ç¡®çš„ Notion API æŸ¥è¯¢é€»è¾‘
- âœ… é›†ä¸­ç®¡ç†æ•°æ®åº“ Schema å®šä¹‰
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… 100% å…¼å®¹å½“å‰ Notion æ•°æ®åº“ç»“æž„

**ä½¿ç”¨æ–¹æ³•**:
```bash
python3 sync_notion_improved.py
```

### æ–¹æ¡ˆ B: ä¿®å¤çŽ°æœ‰è„šæœ¬ (å¤‡é€‰)

å¦‚æžœè¦ç»§ç»­ä½¿ç”¨åŽŸæœ‰è„šæœ¬ï¼Œéœ€è¦ä¿®å¤ä»¥ä¸‹å†…å®¹ï¼š

1. **ä¿®å¤å±žæ€§å** (ç¬¬ 160 è¡Œ)
```python
"çŠ¶æ€": {  # æ”¹ä¸ºä¸­æ–‡
    "status": {"name": new_status}
}
```

2. **ä¿®å¤æŸ¥è¯¢æ¡ä»¶** (ç¬¬ 138-140 è¡Œ)
```python
"property": "åç§°",  # æ”¹ä¸º "åç§°"
"title": {           # æ”¹ä¸º title ç±»åž‹
    "contains": f"#{issue_id}"
}
```

3. **ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µ** (ç¬¬ 163-165 è¡Œ)
```python
# åˆ é™¤ä»¥ä¸‹ä»£ç 
"Code Delta": {
    "number": 1
}
```

---

## ðŸ“Š éƒ¨ç½²æ¸…å•

### æ­¥éª¤ 1: å®‰è£…æ–°è„šæœ¬

```bash
# æ–°è„šæœ¬å·²åˆ›å»ºåœ¨
/opt/mt5-crs/sync_notion_improved.py

# è®¾ç½®å¯æ‰§è¡Œæƒé™
chmod +x /opt/mt5-crs/sync_notion_improved.py
```

### æ­¥éª¤ 2: æ›´æ–° Git Hooks

**é€‰é¡¹ A**: æ›¿æ¢æ—§è„šæœ¬ï¼ˆæŽ¨èï¼‰

```bash
# å¤‡ä»½æ—§è„šæœ¬
cp .git/hooks/post-commit .git/hooks/post-commit.backup

# åˆ›å»ºæ–°çš„ hookï¼ˆè°ƒç”¨æ”¹è¿›çš„è„šæœ¬ï¼‰
cat > .git/hooks/post-commit << 'EOF'
#!/bin/bash
python3 /opt/mt5-crs/sync_notion_improved.py
EOF

chmod +x .git/hooks/post-commit
```

**é€‰é¡¹ B**: ä¿ç•™æ—§è„šæœ¬å¹¶ä¿®å¤ï¼ˆå¦‚æžœéœ€è¦å‘åŽå…¼å®¹ï¼‰

```bash
# ç›´æŽ¥ä¿®æ”¹ update_notion_from_git.py
# æŒ‰ç…§"æ–¹æ¡ˆ B"çš„æ­¥éª¤ä¿®å¤
```

### æ­¥éª¤ 3: éªŒè¯åŒæ­¥

```bash
# æµ‹è¯•æ–°è„šæœ¬
python3 sync_notion_improved.py

# é¢„æœŸè¾“å‡º
======================================================================
ðŸ”„ Notion-Git è‡ªåŠ¨åŒæ­¥ v2.0
======================================================================
ðŸ“ è§£æžæäº¤ä¿¡æ¯
   âœ… æäº¤ç±»åž‹: fix
   âœ… å·¥å•å·: #011, #011.3
ðŸ“Š ç¡®å®šç›®æ ‡çŠ¶æ€: è¿›è¡Œä¸­
ðŸ”„ æ›´æ–°å·¥å•çŠ¶æ€
   âœ… å·¥å• #011: ...
      çŠ¶æ€: è¿›è¡Œä¸­
======================================================================
âœ… åŒæ­¥å®Œæˆ: 2/2 ä¸ªå·¥å•å·²æ›´æ–°
======================================================================
```

---

## ðŸ”„ å·¥ä½œæµç¨‹ (ä¿®å¤åŽ)

### æäº¤ä»£ç æµç¨‹

```
1. å¼€å‘è€…æäº¤ä»£ç ï¼ŒåŒ…å«å·¥å•å· #XXX
   git commit -m "feat(scope): description #011"

2. Git post-commit hook è‡ªåŠ¨è§¦å‘
   â†’ sync_notion_improved.py

3. è„šæœ¬æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
   a. è§£æžæäº¤ä¿¡æ¯ âœ…
   b. æå–å·¥å•å· (#011, #011.3 ç­‰) âœ…
   c. ä½¿ç”¨ "åç§°" å±žæ€§æŸ¥è¯¢ Notion âœ…
   d. ä½¿ç”¨ "çŠ¶æ€" å±žæ€§æ›´æ–°å·¥å• âœ…

4. Notion å·¥å•çŠ¶æ€è‡ªåŠ¨æ›´æ–°
   æœªå¼€å§‹ â†’ è¿›è¡Œä¸­ (æˆ–å¯¹åº”çŠ¶æ€)

5. æ—¥å¿—è¾“å‡ºç¡®è®¤
   âœ… åŒæ­¥å®Œæˆ
```

### çŠ¶æ€æ˜ å°„è¡¨

| æäº¤ç±»åž‹ | ç›®æ ‡çŠ¶æ€ | è¯´æ˜Ž |
|---------|---------|------|
| `feat` | è¿›è¡Œä¸­ | æ–°åŠŸèƒ½å¼€å‘ |
| `fix` | è¿›è¡Œä¸­ | Bug ä¿®å¤ |
| `docs` | è¿›è¡Œä¸­ | æ–‡æ¡£æ›´æ–° |
| `refactor` | è¿›è¡Œä¸­ | ä»£ç é‡æž„ |
| `test` | è¿›è¡Œä¸­ | æµ‹è¯•ç›¸å…³ |
| `chore` | è¿›è¡Œä¸­ | æ‚åŠ¡ |
| `perf` | è¿›è¡Œä¸­ | æ€§èƒ½ä¼˜åŒ– |

---

## ðŸ§ª æµ‹è¯•æ¡ˆä¾‹

### æµ‹è¯• 1: å•ä¸ªå·¥å•æ›´æ–°

```bash
# æäº¤åŒ…å«å·¥å• #011.3
git commit -m "feat(bridge): upgrade gemini review #011.3"

# é¢„æœŸç»“æžœ
# Notion ä¸­ #011.3 çš„çŠ¶æ€åº”è¯¥å˜ä¸º "è¿›è¡Œä¸­"
```

### æµ‹è¯• 2: å¤šä¸ªå·¥å•æ›´æ–°

```bash
# æäº¤åŒ…å«å¤šä¸ªå·¥å•å·
git commit -m "fix(notion): multiple issue sync #011 #011.3"

# é¢„æœŸç»“æžœ
# Notion ä¸­ #011 å’Œ #011.3 çš„çŠ¶æ€éƒ½åº”è¯¥å˜ä¸º "è¿›è¡Œä¸­"
```

### æµ‹è¯• 3: å­å·¥å•æ›´æ–°

```bash
# æäº¤åŒ…å«å­å·¥å•å·
git commit -m "refactor(infra): upgrade gemini #011.3"

# é¢„æœŸç»“æžœ
# Notion ä¸­ #011.3 çš„çŠ¶æ€åº”è¯¥å˜ä¸º "è¿›è¡Œä¸­"
```

---

## ðŸ“ ä¿®å¤æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |
|------|------|------|
| å±žæ€§åä¿®å¤ | âœ… | "Status" â†’ "çŠ¶æ€" |
| æŸ¥è¯¢æ¡ä»¶ä¿®å¤ | âœ… | "ID" â†’ "åç§°"ï¼Œrich_text â†’ title |
| Schema æ ¡éªŒ | âœ… | éªŒè¯æ‰€æœ‰å±žæ€§å­˜åœ¨ |
| æ–°è„šæœ¬åˆ›å»º | âœ… | sync_notion_improved.py |
| Git Hook æ›´æ–° | â³ | éœ€è¦æ‰‹åŠ¨æ›´æ–° |
| æµ‹è¯•éªŒè¯ | âœ… | å·²éªŒè¯ 2/2 å·¥å•åŒæ­¥æˆåŠŸ |

---

## ðŸš€ åŽç»­ç»´æŠ¤

### å®šæœŸæ£€æŸ¥

æ¯ä¸ªæœˆæ£€æŸ¥ä¸€æ¬¡åŒæ­¥æ˜¯å¦æ­£å¸¸ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘ 5 æ¬¡æäº¤çš„åŒæ­¥æ—¥å¿—
git log --oneline -5

# æ‰‹åŠ¨æµ‹è¯•åŒæ­¥
python3 sync_notion_improved.py
```

### æ•…éšœæŽ’æŸ¥

å¦‚æžœåŒæ­¥å¤±è´¥ï¼Œæ£€æŸ¥ï¼š

1. **NOTION_TOKEN æ˜¯å¦æœ‰æ•ˆ**
```bash
echo $NOTION_TOKEN
```

2. **NOTION_ISSUES_DB_ID æ˜¯å¦æ­£ç¡®**
```bash
echo $NOTION_ISSUES_DB_ID
```

3. **Notion æ•°æ®åº“ Schema æ˜¯å¦æ”¹å˜**
```python
# è¿è¡Œä»¥ä¸‹ä»£ç æ£€æŸ¥å±žæ€§
sync = NotionSyncV2()
props = sync.get_notion_db_properties()
print(json.dumps(props, indent=2, ensure_ascii=False))
```

4. **ç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸**
```bash
curl -H "Authorization: Bearer $NOTION_TOKEN" \
  https://api.notion.com/v1/databases/$NOTION_ISSUES_DB_ID
```

---

## ðŸ“š å‚è€ƒèµ„æº

- [Notion API æ–‡æ¡£](https://developers.notion.com/)
- [Git Hooks æ–‡æ¡£](https://git-scm.com/docs/githooks)
- [é¡¹ç›® AI_RULES.md](../AI_RULES.md) - å·¥å•ç®¡ç†è§„èŒƒ

---

**æœ€åŽæ›´æ–°**: 2025-12-22
**ä¿®å¤è€…**: Claude Code DevOps
**çŠ¶æ€**: âœ… å®Œæˆ
