# 阶段1告警实施指南：基础监控落地

## 🎯 目标：让您在30分钟内看到钉钉告警效果

### 实施清单

#### ✅ 前置检查 (5分钟)
- [x] Grafana运行正常: http://47.84.1.161:3000 ✅
- [x] 钉钉webhook已配置 ✅
- [x] 登录凭据: admin / MT5Hub@2025!Secure ✅

#### 🚀 立即执行步骤

### 步骤1: 登录Grafana (1分钟)
1. 打开浏览器访问: http://47.84.1.161:3000
2. 输入用户名: `admin`
3. 输入密码: `MT5Hub@2025!Secure`
4. 点击 "Log in"

### 步骤2: 创建第一个告警规则 (10分钟)

#### 2.1 进入告警页面
1. 点击左侧菜单 "Alerting" → "Alert rules"
2. 点击 "Create alert rule" 按钮

#### 2.2 配置告警规则 - 中枢CPU监控
```
告警名称: [告警] 中枢CPU使用率过高
告警类型: Grafana managed alert
```

#### 2.3 设置查询条件
```
数据源: Prometheus
查询表达式: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
```

#### 2.4 配置告警条件
```
条件: 当查询A的结果 > 85
持续时间: 5分钟
严重程度: Warning
```

#### 2.5 设置告警消息
```
标题: [告警] 中枢CPU使用率过高
描述: 中枢服务器CPU使用率超过85%，可能影响开发和监控服务
```

#### 2.6 配置联系点
```
联系点: dingtalk-mt5-alerts (钉钉)
标签:
  - server: hub
  - severity: warning
  - stage: stage1
```

#### 2.7 保存告警规则
点击 "Save rule" 保存

### 步骤3: 创建第二个告警规则 - 内存监控 (5分钟)

#### 3.1 新建告警规则
点击 "Create alert rule"

#### 3.2 配置基本信息
```
名称: [告警] 中枢内存不足
类型: Grafana managed alert
```

#### 3.3 查询配置
```
数据源: Prometheus
表达式: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 90
```

#### 3.4 告警条件
```
条件: > 90
持续时间: 3分钟
严重程度: Critical
```

#### 3.5 消息配置
```
标题: [告警] 中枢内存不足
描述: 中枢服务器内存使用率超过90%，可能导致服务崩溃
```

#### 3.6 联系点和标签
```
联系点: dingtalk-mt5-alerts
标签:
  - server: hub
  - severity: critical
  - stage: stage1
```

### 步骤4: 创建第三个告警规则 - 服务监控 (5分钟)

#### 4.1 新建告警规则
```
名称: [告警] Grafana服务异常
```

#### 4.2 查询配置
```
数据源: Prometheus
表达式: up{job="grafana"} == 0
```

#### 4.3 告警条件
```
条件: == 0 (服务宕机)
持续时间: 2分钟
严重程度: Critical
```

#### 4.4 消息配置
```
标题: [告警] Grafana监控服务宕机
描述: Grafana监控面板无法访问，影响系统监控能力
```

#### 4.5 联系点配置
```
联系点: dingtalk-mt5-alerts
标签:
  - server: hub
  - service: grafana
  - severity: critical
  - stage: stage1
```

### 步骤5: 测试告警效果 (5分钟)

#### 5.1 触发测试告警
在终端运行以下命令来模拟高CPU使用率:
```bash
# 创建CPU压力测试 (运行1分钟后自动停止)
stress --cpu 2 --timeout 60
```

#### 5.2 观察告警触发
1. 返回Grafana Alerting页面
2. 查看 "Firing" 状态的告警
3. 检查钉钉群收到告警消息

#### 5.3 验证钉钉消息格式
钉钉应该收到类似消息:
```
[告警] 中枢CPU使用率过高

中枢服务器CPU使用率超过85%，可能影响开发和监控服务

Labels:
- server: hub
- severity: warning
- stage: stage1
```

### 步骤6: 优化和观察 (5分钟)

#### 6.1 检查告警状态
- 绿色: 正常状态
- 红色: 正在告警
- 橙色: 等待评估

#### 6.2 查看告警历史
点击 "Alerting" → "Alert history" 查看告警记录

#### 6.3 调整阈值 (可选)
根据实际系统负载调整告警阈值

## 🎉 验收标准

### 必须达成的目标
- [ ] 成功登录Grafana
- [ ] 创建了3个告警规则
- [ ] 告警规则状态为 "Normal"
- [ ] 触发测试后收到钉钉告警
- [ ] 钉钉消息包含正确的告警信息

### 可选优化项目
- [ ] 告警消息格式美观
- [ ] 告警分组合理
- [ ] 响应时间合理

## 🔧 故障排除

### 问题1: 无法创建告警规则
**原因**: 缺少Prometheus数据源
**解决**:
1. 检查数据源配置: Configuration → Data sources
2. 确保Prometheus连接正常

### 问题2: 告警不触发
**原因**: 查询表达式错误
**解决**:
1. 在Explore页面测试查询表达式
2. 确认有数据返回

### 问题3: 钉钉收不到消息
**原因**: 联系点配置错误
**解决**:
1. 检查联系点设置
2. 验证webhook URL
3. 测试联系点连通性

### 问题4: 权限错误
**原因**: 用户权限不足
**解决**: 使用admin账户操作

## 📞 获取帮助

如果遇到问题，请提供:
1. 当前操作步骤
2. 错误信息截图
3. Grafana页面状态

## 🚀 下一步规划

完成阶段1后，可以继续:
- 阶段1扩展: 添加更多服务监控
- 阶段2准备: 训练服务器监控
- 阶段3准备: 业务指标监控

**立即开始实施吧！让我们看到钉钉告警的实际效果！** 🔔📱
