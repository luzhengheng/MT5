# Gemini Pro 代码审查报告

**时间**: 2025-12-23T00:58:39.177981

## 审查请求

```
# MT5-CRS 项目审查请求

## 项目概览
- **项目名称**: MT5-CRS
- **当前阶段**: 工单 #011 实盘交易系统对接
- **最后更新**: 2025-12-23T00:58:05.456303
- **当前焦点**: MT5 API 集成与实盘交易系统

## Git 状态
- **当前分支**: Unknown
- **最新提交**: No commits
- **未提交更改**: 0 个文件

## 优先任务

## AI Command Center 最新任务
- 无法获取AI任务信息

## 核心代码审查

### 📄 src/strategy/risk_manager.py
```python
"""
风险管理模块 - Kelly Criterion 注码策略与动态风控

核心组件：
1. KellySizer: 基于 Kelly 公式的动态仓位管理
2. DynamicRiskManager: 账户级风险监控和熔断机制
"""

import backtrader as bt
import numpy as np
import logging
from typing import Optional
from src.strategy.session_risk_manager import SessionRiskManager, get_session_risk_manager

logger = logging.getLogger(__name__)


class KellySizer(bt.Sizer):
    """
    Kelly Criterion 仓位管理器（通用公式版本）

    公式：
        f* = [p(b+1) - 1] / b

    其中：
        - f*: Kelly 风险比例（Optimal Risk Fraction）
        - p: 预测胜率（从 ML 模型输出的 y_pred_proba 或 HierarchicalSignalFusion 置信度）
        - b: 赔率（策略的 take_profit_ratio，即盈亏比）

    仓位计算：
        Risk Amount = Account Value * f* * k...
```

## 审查结果

### 1. 🛡️ 深度代码审计 (Audit)

基于提供的代码片段，针对 MT5 实盘对接目标进行深度审查：

*   **逻辑闭环与实盘差异 (Critical)**:
    *   **`KellySizer` 数据依赖性**: `KellySizer` 严重依赖 `data.y_pred_proba_long` 等自定义 Line。在回测中 (`MLDataFeed`) 这些是预计算好的列。但在 MT5 实盘中，数据是 Tick/Bar 级实时推送的，ML 推理必须在 `next()` 之前完成并注入到 DataFeed 中。如果实盘 DataFeed 没有正确映射这些 Line，`KellySizer` 会因属性不存在或值为 NaN 而崩溃。
    *   **账户净值获取**: `self.broker.getvalue()` 在 Backtrader 回测中是模拟值。对接 MT5 时，必须确保使用的 `MT5Broker` 实现正确映射了 `AccountInfoDouble(ACCOUNT_EQUITY)`，否则 Kelly 公式计算的仓位将完全错误。

*   **类型安全与异常处理**:
    *   **`_get_win_probability` 返回值**: 该方法被标注返回 `Optional[float]`。如果 ML 模型在实盘中因网络或计算延迟未返回概率（即返回 `None`），调用方（未展示的 `_getsizing`）若直接进行数学运算会引发 `TypeError`。必须设置默认兜底胜率（如 0.5 或跳过交易）。
    *   **API 异常**: `nexus_with_proxy.py` 中 `call_gemini_direct` 仅捕获通用 `Exception`。建议区分 `requests.exceptions.Timeout` 和 API 业务错误，以便实施不同的重试策略。

*   **资源管理**:
    *   **多进程清理**: `bin/run_backtest.py` 使用了 `ProcessPoolExecutor`。虽然 `with` 语句处理了上下文，但在某些操作系统（如 Windows）下，如果子进程中发生段错误或死锁，可能导致僵尸进程。建议添加 `signal` 处理来确保优雅退出。

*   **并发安全**:
    *   **MT5 同步阻塞**: 标准 `MetaTrader5` Python 库是同步阻塞的。如果 `MLStrategy` 的计算（特征工程+推理）耗时较长，会阻塞 MT5 的心跳检测或 Tick 接收。

### 2. ⚡ 性能与架构优化 (Optimize)

*   **MT5 异步架构 (Async Wrapper)**:
    *   **现状**: 当前架构看似基于同步的 Backtrader `Cerebro`。
    *   **建议**: 针对实盘，建议在 `Cerebro` 外部包裹一层 `AsyncIO` 循环。将 MT5 的 `symbol_info_tick` 和 `history_orders_get` 放入线程池 (`run_in_executor`) 或使用独立的轮询线程，通过 `Queue` 将数据喂给策略，避免网络 I/O 阻塞策略逻辑。

*   **风控状态持久化 (Persistence)**:
    *   **现状**: `DynamicRiskManager` (推测在内存中) 管理账户级风控。
    *   **建议**: 实盘系统必须具备“崩溃恢复”能力。建议引入 SQLite 或 Redis 记录当天的 `realized_pnl` 和 `trade_count`。若程序重启，需从数据库恢复风控状态，防止因重启导致“每日最大亏损”计数器归零从而突破风控限制。

*   **推理延迟优化 (Caching)**:
    *   **建议**: ML 特征计算通常存在重复。对于 `run_backtest.py` 中的 `MLDataFeed`，如果特征计算昂贵，建议对 `_get_win_probability` 或特征提取函数应用 `functools.lru_cache`（针对即时数据）或将预计算特征存为 Parquet 文件，大幅加速 Walk-Forward 回测。

### 3. 📝 推荐 Git Commit Message

```bash
git commit -m "feat(mt5): harden risk manager for live execution & fix data dependencies #011.3"
```

### 4. 📋 Notion 进度简报

**MT5-CRS 代码审查摘要 #011**

*   **🔴 核心风险**: `KellySizer` 在实盘环境下极易因缺少 ML 预测数据 (`y_pred_proba`) 而崩溃。回测数据流与实盘数据流存在架构断层。
*   **⚠️ 改进建议**:
    1.  **高优先级**: 在 `KellySizer` 中添加对 `None` 概率的空值检查和默认行为。
    2.  **中优先级**: 实现风控状态（日内盈亏）的本地持久化 (SQLite)，防止重启后风控失效。
    3.  **架构**: 确认 `MT5DataFeed` 能够实时调用 ML 模型并将结果注入 Backtrader 的 Lines 中。
*   **下一步**: 完成 `MT5Broker` 与 `KellySizer` 的集成测试，验证实时净值读取准确性。
